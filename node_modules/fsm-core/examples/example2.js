/**
 * Created by Ricardo Morais on 27/03/2017.
 */
let core =  require('./../index')('mysql', 'localhost', 'root', 'root', 'mydatabase');
let ioCore = core.dependencies.ioCore;

let co = require("co");
core.sequelize.sync().then(function() {

    co(function *() {
        try {
            let inputExpired = yield ioCore.action.createInput('expired');
            let data = yield core.action.createFSM("deadline");
            let version = data.version;
            let initialState = yield core.action.createState("initial", version.dataValues.id);
            let generatedState = yield core.action.createState('generated', version.dataValues.id);
            let validatedState = yield core.action.createState('validated', version.dataValues.id);
            let extensionState = yield core.action.createState('extension', version.dataValues.id);
            let expiredState = yield core.action.createState('expired', version.dataValues.id);
            let transitionValidatedToExpired = yield core.action.createTransition(
                validatedState.dataValues.id,
                expiredState.dataValues.id);
            let transitionInput1 = yield core.action.bindInputToTransition(
                inputExpired.dataValues.id,
                transitionValidatedToExpired.dataValues.id);
            yield core.action.setInitialState(initialState.dataValues.id, version.dataValues.id);
            let action = yield ioCore.action.createAction('log', [{
                name: "title",
                type: "string"
            }, {
                name: "text",
                type: "string"
            }]);
            let action2 = yield ioCore.action.createAction('setInstanceProperty', [{
                name: "parameterName",
                type: "string"
            }, {
                name: "value",
                type: "any"
            }]);


            let parametersResult = yield ioCore.query.getActionParameters(action.dataValues.id);
            let parameters = [];
            for(let param of parametersResult) {
                parameters.push({
                    id: param.dataValues.id,
                    name: param.dataValues.name,
                    type: param.dataValues.type
                });
            }
            let actionCall = yield ioCore.action.createActionCall(action.dataValues.id, {
                title: "Test",
                text: "My text"
            });
            let actionCall2 = yield ioCore.action.createActionCall(action2.dataValues.id, {
                parameterName: "Test",
                value: "My text"
            });
            yield core.action.onEnter(actionCall2.dataValues.id, initialState.dataValues.id);
            yield core.action.seal(version.dataValues.id);
        } catch(error){
            console.log(error);
        }
    })
});

