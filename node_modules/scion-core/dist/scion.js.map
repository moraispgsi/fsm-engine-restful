{"version":3,"sources":["../lib/scion.js"],"names":["extend","Object","assign","to","from","keys","forEach","k","STATE_TYPES","BASIC","COMPOSITE","PARALLEL","HISTORY","INITIAL","FINAL","ioProcessorTypes","location","transitionWithTargets","t","targets","transitionComparator","t1","t2","documentOrder","initializeModel","rootState","transitions","idToStateMap","Map","idCount","generateId","type","undefined","count","wrapInFakeRootState","state","$deserializeDatamodel","$serializeDatamodel","$idToStateMap","states","$type","target","statesWithInitialAttributes","transitionToString","sourceState","events","join","cond","name","stateToString","id","traverse","ancestors","printTrace","toString","push","apply","has","Error","set","depth","length","parent","j","len","transition","source","bind","ancs","concat","typeEnum","descendants","map","s","reduce","a","b","initialChildren","initial","filter","child","initialRef","checkInitialRef","historyChildren","historyRef","onEntry","Array","isArray","onExit","connectIntialAttributes","get","RX_WHITESPACE","connectTransitionGraph","i","onTransition","event","trim","split","lcca","getLCCA","scope","getScope","transitionIsReallyInternal","every","indexOf","s1","s2","commonAncestors","anc","fakeRootState","EventEmitter","_listeners","prototype","on","_on","listener","once","_once","self","__once","args","arguments","off","_off","index","splice","emit","_emit","slice","call","modifiedArgs","listeners","ArraySet","l","o","Set","add","x","remove","delete","union","v","difference","contains","iter","isEmpty","size","equals","RX_TRAILING_WILDCARD","isEventPrefixMatch","prefix","fullName","replace","charAt","isTransitionMatch","eventName","some","tEvent","scxmlPrefixTransitionSelector","evaluator","selectEventlessTransitions","eventlessTransitionSelector","query","getAncestors","root","getAncestorsOrSelf","getDescendantsOrSelf","isOrthogonalTo","isAncestrallyRelatedTo","getLCA","getTransitionWithHigherSourceChildPriority","_args","r","getStateWithHigherSourceChildPriority","initializeModelGeneratorFn","modelFn","opts","interpreter","sessionid","ioprocessors","isIn","deserializeSerializedConfiguration","serializedConfiguration","deserializeHistory","serializedHistory","sid","BaseInterpreter","EVENTS","modelOrFnGenerator","_scriptingContext","interpreterScriptingContext","InterpreterScriptingContext","model","JSON","parse","_model","console","log","priorityComparisonFn","transitionSelector","_internalEventQueue","snapshot","_configuration","_historyValue","_isInFinalState","_x","_sessionId","sessionId","_name","_ioprocessors","_log","beget","start","_performBigStep","getConfiguration","startAsync","cb","nop","_performBigStepAsync","getFullConfiguration","stateName","isFinal","e","keepGoing","currentEvent","shift","selectedTransitions","_selectTransitions","_performSmallStep","doBigStep","eventToEmit","err","setImmediate","stringify","selectedTransitionsWithTargets","exitedTuple","_getStatesExited","basicStatesExited","statesExited","enteredTuple","_getStatesEntered","basicStatesEntered","statesEntered","eventsToAddToInnerQueue","stateExited","exitIdx","exitLen","_evaluateAction","f","isDeep","s0","sortedTransitions","sort","stxIdx","targetIds","txIdx","txLen","enterIdx","enterLen","stateEntered","entryIdx","entryLen","actionRef","tagname","line","column","reason","message","data","transitionList","desc","configList","cfgIdx","cfgLen","ancIdx","ancLen","sortedStatesExited","statesToEnter","basicStatesToEnter","statesProcessed","statesToProcess","targetIdx","targetLen","_addStateAndAncestors","pop","_addStateAndDescendants","sortedStatesEntered","stateFromHistory","onlySelectFromBasicStates","statesAndParents","idx","basicState","enabledTransitions","stateIdx","stateLen","priorityEnabledTransitions","_selectPriorityEnabledTransitions","tuple","_getInconsistentTransitions","consistentTransitions","inconsistentTransitionsPairs","allInconsistentTransitions","_conflicts","arg","__proto__","_isArenaOrthogonal","isOrthogonal","registerListener","unregisterListener","getAllTransitionEvents","getEvents","getSnapshot","_isStepping","_serializeHistory","Statechart","processorType","F","gen","evtObjOrName","optionalData","genAsync","config","_interpreter","_timeoutMap","validateUriRegex","raise","send","options","validateSend","sendAction","targetIsValidUri","test","sendid","eventProcessorTypes","defaultSendAction","setTimeout","timeoutId","delay","publish","scxml","sendFn","customSend","cancel","customCancel","clearTimeout","module","exports"],"mappings":"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","file":"scion.js","sourcesContent":["//   Copyright 2011-2012 Jacob Beard, INFICON, and other SCION contributors\n//\n//   Licensed under the Apache License, Version 2.0 (the \"License\");\n//   you may not use this file except in compliance with the License.\n//   You may obtain a copy of the License at\n//\n//       http://www.apache.org/licenses/LICENSE-2.0\n//\n//   Unless required by applicable law or agreed to in writing, software\n//   distributed under the License is distributed on an \"AS IS\" BASIS,\n//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n//   See the License for the specific language governing permissions and\n//   limitations under the License.\n\n\"use strict\";\n\nvar extend = Object.assign || \n    function (to, from){\n      Object.keys(from).forEach(function(k){\n        to[k] = from[k]; \n      });\n      return to;\n    };\n\nvar STATE_TYPES = {\n    BASIC: 0,\n    COMPOSITE: 1,\n    PARALLEL: 2,\n    HISTORY: 3,\n    INITIAL: 4,\n    FINAL: 5\n};\n\nvar ioProcessorTypes = {\n    'scxml': {\n        location: 'http://www.w3.org/TR/scxml/#SCXMLEventProcessor'\n    },\n    'basichttp': {\n        location: 'http://www.w3.org/TR/scxml/#BasicHTTPEventProcessor'\n    },\n    'dom': {\n        location: 'http://www.w3.org/TR/scxml/#DOMEventProcessor'\n    },\n    'publish': {\n        location: 'https://github.com/jbeard4/SCION#publish'\n    }\n};\n\nfunction transitionWithTargets(t){\n    return t.targets;\n}\n\nfunction transitionComparator(t1, t2) {\n    return t1.documentOrder - t2.documentOrder;\n}\n\nfunction initializeModel(rootState){\n    var transitions = [], idToStateMap = new Map(), documentOrder = 0;\n\n\n    //TODO: need to add fake ids to anyone that doesn't have them\n    //FIXME: make this safer - break into multiple passes\n    var idCount = {};\n\n    function generateId(type){\n        if(idCount[type] === undefined) idCount[type] = 0;\n\n        var count = idCount[type]++;\n        return '$generated-' + type + '-' + count; \n    }\n\n    function wrapInFakeRootState(state){\n        return {\n            $deserializeDatamodel : state.$deserializeDatamodel || function(){},\n            $serializeDatamodel : state.$serializeDatamodel || function(){ return null;},\n            $idToStateMap : idToStateMap,   //keep this for handy deserialization of serialized configuration\n            states : [\n                {\n                    $type : 'initial',\n                    transitions : [{\n                        target : state\n                    }]\n                },\n                state\n            ]\n        };\n    }\n\n    var statesWithInitialAttributes = [];\n\n    function transitionToString(sourceState){\n      return `${sourceState} -- ${this.events ? '(' + this.events.join(',') + ')' : null}${this.cond ? '[' + this.cond.name + ']' : ''} --> ${this.targets ? this.targets.join(',') : null}`;\n    }\n\n    function stateToString(){\n      return this.id;\n    }\n\n    function traverse(ancestors,state){\n\n        if(printTrace) state.toString = stateToString;\n\n        //add to global transition and state id caches\n        if(state.transitions) transitions.push.apply(transitions,state.transitions);\n\n        //populate state id map\n        if(state.id){\n            if(idToStateMap.has(state.id)) throw new Error('Redefinition of state id ' + state.id);\n\n            idToStateMap.set(state.id, state);\n        }\n\n        //create a default type, just to normalize things\n        //this way we can check for unsupported types below\n        state.$type = state.$type || 'state';\n\n        //add ancestors and depth properties\n        state.ancestors = ancestors;\n        state.depth = ancestors.length;\n        state.parent = ancestors[0];\n        state.documentOrder = documentOrder++; \n\n        //add some information to transitions\n        state.transitions = state.transitions || [];\n        for (var j = 0, len = state.transitions.length; j < len; j++) {\n            var transition = state.transitions[j];\n            transition.documentOrder = documentOrder++; \n            transition.source = state;\n            if(printTrace) transition.toString = transitionToString.bind(transition, state);\n        };\n\n        //recursive step\n        if(state.states) {\n            var ancs = [state].concat(ancestors);\n            for (var j = 0, len = state.states.length; j < len; j++) {\n                traverse(ancs, state.states[j]);\n            }\n        }\n\n        //setup fast state type\n        switch(state.$type){\n            case 'parallel':\n                state.typeEnum = STATE_TYPES.PARALLEL;\n                break;\n            case 'initial' : \n                state.typeEnum = STATE_TYPES.INITIAL;\n                break;\n            case 'history' :\n                state.typeEnum = STATE_TYPES.HISTORY;\n                break;\n            case 'final' : \n                state.typeEnum = STATE_TYPES.FINAL;\n                break;\n            case 'state' : \n            case 'scxml' :\n                if(state.states && state.states.length){\n                    state.typeEnum = STATE_TYPES.COMPOSITE;\n                }else{\n                    state.typeEnum = STATE_TYPES.BASIC;\n                }\n                break;\n            default :\n                throw new Error('Unknown state type: ' + state.$type);\n        }\n\n        //descendants property on states will now be populated. add descendants to this state\n        if(state.states){\n            state.descendants = state.states.concat(state.states.map(function(s){return s.descendants;}).reduce(function(a,b){return a.concat(b);},[]));\n        }else{\n            state.descendants = [];\n        }\n\n        var initialChildren;\n        if(state.typeEnum === STATE_TYPES.COMPOSITE){\n            //set up initial state\n            \n            if(typeof state.initial === 'string'){\n                statesWithInitialAttributes.push(state);\n            }else{\n                //take the first child that has initial type, or first child\n                initialChildren = state.states.filter(function(child){\n                    return child.$type === 'initial';\n                });\n\n                state.initialRef = initialChildren.length ? initialChildren[0] : state.states[0];\n                checkInitialRef(state);\n            }\n\n        }\n\n        //hook up history\n        if(state.typeEnum === STATE_TYPES.COMPOSITE ||\n                state.typeEnum === STATE_TYPES.PARALLEL){\n\n            var historyChildren = state.states.filter(function(s){\n                return s.$type === 'history';\n            }); \n\n           state.historyRef = historyChildren[0];\n        }\n\n        //now it's safe to fill in fake state ids\n        if(!state.id){\n            state.id = generateId(state.$type);\n            idToStateMap.set(state.id, state);\n        }\n\n        //normalize onEntry/onExit, which can be single fn or array\n        if (state.onEntry && !Array.isArray(state.onEntry)) {\n            state.onEntry = [state.onEntry];\n        }\n\n        if (state.onExit && !Array.isArray(state.onExit)) {\n            state.onExit = [state.onExit];\n        }\n    }\n\n    //TODO: convert events to regular expressions in advance\n\n    function checkInitialRef(state){\n      if(!state.initialRef) throw new Error('Unable to locate initial state for composite state: ' + state.id);\n    }\n    function connectIntialAttributes(){\n      for (var j = 0, len = statesWithInitialAttributes.length; j < len; j++) {\n        var s = statesWithInitialAttributes[j];\n        s.initialRef = idToStateMap.get(s.initial);\n        checkInitialRef(s);\n      }\n    }\n\n    var RX_WHITESPACE = /\\s+/;\n\n    function connectTransitionGraph(){\n        //normalize as with onEntry/onExit\n        for (var i = 0, len = transitions.length; i < len; i++) {\n            var t = transitions[i];\n            if (t.onTransition && !Array.isArray(t.onTransition)) {\n                t.onTransition = [t.onTransition];\n            }\n\n            //normalize \"event\" attribute into \"events\" attribute\n            if (typeof t.event === 'string') {\n                t.events = t.event.trim().split(RX_WHITESPACE);\n            }\n            delete t.event;\n\n            if(t.targets || (typeof t.target === 'undefined')) {\n                //targets have already been set up\n                continue;\n            }   \n\n            if(typeof t.target === 'string'){\n                var target = idToStateMap.get(t.target);\n                if(!target) throw new Error('Unable to find target state with id ' + t.target);\n                t.target = target;\n                t.targets = [t.target];\n            }else if(Array.isArray(t.target)){\n                t.targets = t.target.map(function(target){\n                    if(typeof target === 'string'){\n                        target = idToStateMap.get(target);\n                        if(!target) throw new Error('Unable to find target state with id ' + t.target);\n                        return target;\n                    }else{\n                        return target;\n                    } \n                }); \n            }else if(typeof t.target === 'object'){\n                t.targets = [t.target];\n            }else{\n                throw new Error('Transition target has unknown type: ' + t.target);\n            }\n        }\n\n        //hook up LCA - optimization\n        for (var i = 0, len = transitions.length; i < len; i++) {\n            var t = transitions[i];\n            if(t.targets) t.lcca = getLCCA(t.source,t.targets[0]);    //FIXME: we technically do not need to hang onto the lcca. only the scope is used by the algorithm\n\n            t.scope = getScope(t);\n            //console.log('scope',t.source.id,t.scope.id,t.targets);\n        }\n    }\n\n    function getScope(transition){\n        //Transition scope is normally the least common compound ancestor (lcca).\n        //Internal transitions have a scope equal to the source state.\n\n        var transitionIsReallyInternal = \n                transition.type === 'internal' &&\n                    transition.source.parent &&    //root state won't have parent\n                        transition.targets && //does it target its descendants\n                            transition.targets.every(\n                                function(target){ return transition.source.descendants.indexOf(target) > -1;});\n\n        if(!transition.targets){\n            return transition.source; \n        }else if(transitionIsReallyInternal){\n            return transition.source; \n        }else{\n            return transition.lcca;\n        }\n    }\n\n    function getLCCA(s1, s2) {\n        //console.log('getLCCA',s1, s2);\n        var commonAncestors = [];\n        for (var j = 0, len = s1.ancestors.length; j < len; j++) {\n            var anc = s1.ancestors[j];\n            //console.log('s1.id',s1.id,'anc',anc.id,'anc.typeEnum',anc.typeEnum,'s2.id',s2.id);\n            if(anc.typeEnum === STATE_TYPES.COMPOSITE &&\n                anc.descendants.indexOf(s2) > -1){\n                commonAncestors.push(anc);\n            }\n        };\n        //console.log('commonAncestors',s1.id,s2.id,commonAncestors.map(function(s){return s.id;}));\n        if(!commonAncestors.length) throw new Error(\"Could not find LCA for states.\");\n        return commonAncestors[0];\n    }\n\n    //main execution starts here\n    //FIXME: only wrap in root state if it's not a compound state\n    var fakeRootState = wrapInFakeRootState(rootState);  //I wish we had pointer semantics and could make this a C-style \"out argument\". Instead we return him\n    traverse([],fakeRootState);\n    connectTransitionGraph();\n    connectIntialAttributes();\n\n    return fakeRootState;\n}\n\n/* begin tiny-events: https://github.com/ZauberNerd/tiny-events */\nfunction EventEmitter() {\n    this._listeners = {};\n    this._listeners['*'] = [];\n}\n\nEventEmitter.prototype.on = function _on(type, listener) {\n    if (!Array.isArray(this._listeners[type])) {\n        this._listeners[type] = [];\n    }\n\n    if (this._listeners[type].indexOf(listener) === -1) {\n        this._listeners[type].push(listener);\n    }\n\n    return this;\n};\n\nEventEmitter.prototype.once = function _once(type, listener) {\n    var self = this;\n\n    function __once() {\n        for (var args = [], i = 0; i < arguments.length; i += 1) {\n            args[i] = arguments[i];\n        }\n\n        self.off(type, __once);\n        listener.apply(self, args);\n    }\n\n    __once.listener = listener;\n\n    return this.on(type, __once);\n};\n\nEventEmitter.prototype.off = function _off(type, listener) {\n    if (!Array.isArray(this._listeners[type])) {\n        return this;\n    }\n\n    if (typeof listener === 'undefined') {\n        this._listeners[type] = [];\n        return this;\n    }\n\n    var index = this._listeners[type].indexOf(listener);\n\n    if (index === -1) {\n        for (var i = 0; i < this._listeners[type].length; i += 1) {\n            if (this._listeners[type][i].listener === listener) {\n                index = i;\n                break;\n            }\n        }\n    }\n\n    this._listeners[type].splice(index, 1);\n    return this;\n};\n\nEventEmitter.prototype.emit = function _emit(type) {\n\n    var args = Array.prototype.slice.call(arguments);\n    var modifiedArgs = args.slice(1);\n\n    var listeners = this._listeners[type];\n    var j, len;\n    if (Array.isArray(listeners)) {\n      for (j = 0, len = listeners.length; j < len; j++) {\n        listeners[j].apply(this, modifiedArgs);\n      }\n    }\n\n    //special '*' event\n    listeners = this._listeners['*'];\n    for (j = 0, len = listeners.length; j < len; j++) {\n        listeners[j].apply(this, args);\n    }\n\n    return this;\n};\n\n/* end tiny-events */\n\n/* begin ArraySet */\n\n/** @constructor */\nfunction ArraySet(l) {\n    l = l || [];\n    this.o = new Set(l);        \n}\n\nArraySet.prototype = {\n\n    add : function(x) {\n        this.o.add(x);\n    },\n\n    remove : function(x) {\n        return this.o.delete(x);\n    },\n\n    union : function(l) {\n        for (var v of l.o) {\n            this.o.add(v);\n        }\n        return this;\n    },\n\n    difference : function(l) {\n        for (var v of l.o) {\n            this.o.delete(v);\n        }\n        return this;\n    },\n\n    contains : function(x) {\n        return this.o.has(x);\n    },\n\n    iter : function() {\n        return Array.from(this.o);\n    },\n\n    isEmpty : function() {\n        return !this.o.size;\n    },\n\n    size: function() {\n        return this.o.size;\n    },\n\n    equals : function(s2) {\n        if (this.o.size !== s2.size()) {\n            return false;\n        }\n\n        for (var v of this.o) {\n            if (!s2.contains(v)) {\n                return false;\n            }\n        }\n\n        return true;\n    },\n\n    toString : function() {\n        return this.o.size === 0 ? '<empty>' : Array.from(this.o).join(',\\n');\n    }\n};\n\nconst RX_TRAILING_WILDCARD = /\\.\\*$/;\n\nfunction isEventPrefixMatch(prefix, fullName) {\n    prefix = prefix.replace(RX_TRAILING_WILDCARD, '');\n\n    if (prefix === fullName) {\n        return true;\n    }\n\n    if (prefix.length > fullName.length) {\n        return false;\n    }\n\n    if (fullName.charAt(prefix.length) !== '.') {\n        return false;\n    }\n\n    return (fullName.indexOf(prefix) === 0);\n}\n\nfunction isTransitionMatch(t, eventName) {\n    return t.events.some((tEvent) => {\n        return tEvent === '*' || isEventPrefixMatch(tEvent, eventName);\n    });\n}\n\nfunction scxmlPrefixTransitionSelector(state, event, evaluator, selectEventlessTransitions) {\n    return state.transitions.filter((t) => {\n        return ( \n          selectEventlessTransitions ? \n            !t.events :\n            (!t.events || (event && event.name && isTransitionMatch(t, event.name)))\n          )\n          && (!t.cond || evaluator(t.cond));\n    });\n}\n\nfunction eventlessTransitionSelector(state){\n  return state.transitions.filter(function(transition){ return !transition.events || ( transition.events && transition.events.length === 0 ); });\n}\n\n//model accessor functions\nvar query = {\n    getAncestors: function(s, root) {\n        var ancestors, index, state;\n        index = s.ancestors.indexOf(root);\n        if (index > -1) {\n            return s.ancestors.slice(0, index);\n        } else {\n            return s.ancestors;\n        }\n    },\n    /** @this {model} */\n    getAncestorsOrSelf: function(s, root) {\n        return [s].concat(this.getAncestors(s, root));\n    },\n    getDescendantsOrSelf: function(s) {\n        return [s].concat(s.descendants);\n    },\n    /** @this {model} */\n    isOrthogonalTo: function(s1, s2) {\n        //Two control states are orthogonal if they are not ancestrally\n        //related, and their smallest, mutual parent is a Concurrent-state.\n        return !this.isAncestrallyRelatedTo(s1, s2) && this.getLCA(s1, s2).typeEnum === STATE_TYPES.PARALLEL;\n    },\n    /** @this {model} */\n    isAncestrallyRelatedTo: function(s1, s2) {\n        //Two control states are ancestrally related if one is child/grandchild of another.\n        return this.getAncestorsOrSelf(s2).indexOf(s1) > -1 || this.getAncestorsOrSelf(s1).indexOf(s2) > -1;\n    },\n    /** @this {model} */\n    getLCA: function(s1, s2) {\n        var commonAncestors = this.getAncestors(s1).filter(function(a){\n            return a.descendants.indexOf(s2) > -1;\n        },this);\n        return commonAncestors[0];\n    }\n};\n\n//priority comparison functions\nfunction getTransitionWithHigherSourceChildPriority(_args) {\n    let t1 = _args[0], t2 = _args[1];\n    var r = getStateWithHigherSourceChildPriority(t1.source, t2.source);\n    //compare transitions based first on depth, then based on document order\n    if (t1.source.depth < t2.source.depth) {\n        return t2;\n    } else if (t2.source.depth < t1.source.depth) {\n        return t1;\n    } else {\n       if (t1.documentOrder < t2.documentOrder) {\n            return t1;\n        } else {\n            return t2;\n        }\n    }\n}\n\nfunction getStateWithHigherSourceChildPriority(s1, s2) {\n    //compare states based first on depth, then based on document order\n    if (s1.depth > s2.depth) {\n        return -1;\n    } else if (s1.depth < s2.depth) {\n        return 1;\n    } else {\n        //Equality\n        if (s1.documentOrder < s2.documentOrder) {\n            return 1;\n        } else if (s1.documentOrder > s2.documentOrder) {\n            return -1;\n        } else{\n            return 0;\n        }\n    }\n}\n\nfunction initializeModelGeneratorFn(modelFn, opts, interpreter){\n\n     opts.x =  opts.x || {};\n\n    return modelFn.call(interpreter,\n        opts.x,\n        opts.sessionid,\n        opts.ioprocessors,\n        interpreter.isIn.bind(interpreter));\n}\n\nfunction deserializeSerializedConfiguration(serializedConfiguration,idToStateMap){\n  return serializedConfiguration.map(function(id){\n    var state = idToStateMap.get(id);\n    if(!state) throw new Error('Error loading serialized configuration. Unable to locate state with id ' + id);\n    return state;\n  });\n}\n\nfunction deserializeHistory(serializedHistory,idToStateMap){\n  var o = {};\n  Object.keys(serializedHistory).forEach(function(sid){\n    o[sid] = serializedHistory[sid].map(function(id){\n      var state = idToStateMap.get(id);\n      if(!state) throw new Error('Error loading serialized history. Unable to locate state with id ' + id);\n      return state;\n    });\n  });\n  return o;\n}\n\n/** @const */\nvar printTrace = false;\n\nBaseInterpreter.EVENTS = [\n  'onEntry',\n  'onExit',\n  'onTransition',\n  'onError',\n  'onBigStepBegin',\n  'onBigStepSuspend',\n  'onBigStepResume',\n  'onSmallStepBegin',\n  'onSmallStepEnd',\n  'onBigStepEnd'\n];\n\n/** @constructor */\nfunction BaseInterpreter(modelOrFnGenerator, opts){\n\n    EventEmitter.call(this);\n\n    this._scriptingContext = opts.interpreterScriptingContext || (opts.InterpreterScriptingContext ? new opts.InterpreterScriptingContext(this) : {}); \n\n    var model;\n    if(typeof modelOrFnGenerator === 'function'){\n        model = initializeModelGeneratorFn(modelOrFnGenerator, opts, this);\n    }else if(typeof modelOrFnGenerator === 'string'){\n        model = JSON.parse(modelOrFnGenerator);\n    }else{\n        model = modelOrFnGenerator;\n    }\n\n    this._model = initializeModel(model);\n\n    //console.log(require('util').inspect(this._model,false,4));\n   \n    this.opts = opts || {};\n\n    this.opts.console = opts.console || (typeof console === 'undefined' ? {log : function(){}} : console);   //rely on global console if this console is undefined\n    this.opts.Set = this.opts.Set || ArraySet;\n    this.opts.priorityComparisonFn = this.opts.priorityComparisonFn || getTransitionWithHigherSourceChildPriority;\n    this.opts.transitionSelector = this.opts.transitionSelector || scxmlPrefixTransitionSelector;\n\n    this._scriptingContext.log = this._scriptingContext.log || (function log(){ \n      if(this.opts.console.log.apply){\n        this.opts.console.log.apply(this.opts.console, arguments); \n      } else {\n        //console.log on older IE does not support Function.apply, so just pass him the first argument. Best we can do for now.\n        this.opts.console.log(Array.prototype.slice.apply(arguments).join(',')); \n      }\n    }.bind(this));   //set up default scripting context log function\n\n    this._internalEventQueue = [];\n\n    //check if we're loading from a previous snapshot\n    if(opts.snapshot){\n      this._configuration = new this.opts.Set(deserializeSerializedConfiguration(opts.snapshot[0], this._model.$idToStateMap));\n      this._historyValue = deserializeHistory(opts.snapshot[1], this._model.$idToStateMap); \n      this._isInFinalState = opts.snapshot[2];\n      this._model.$deserializeDatamodel(opts.snapshot[3]);   //load up the datamodel\n    }else{\n      this._configuration = new this.opts.Set();\n      this._historyValue = {};\n      this._isInFinalState = false;\n    }\n\n    //SCXML system variables:\n    this._x = {\n        _sessionId : opts.sessionId || null,\n        _name : model.name || opts.name || null,\n        _ioprocessors : opts.ioprocessors || null\n    };\n\n    //add debug logging\n    BaseInterpreter.EVENTS.forEach(function(event){\n      this.on(event, this._log.bind(this,event));\n    }, this);\n}\n\nBaseInterpreter.prototype = extend(beget(EventEmitter.prototype),{\n\n    /** @expose */\n    start : function() {\n        //perform big step without events to take all default transitions and reach stable initial state\n        this._log(\"performing initial big step\");\n\n        //We effectively need to figure out states to enter here to populate initial config. assuming root is compound state makes this simple.\n        //but if we want it to be parallel, then this becomes more complex. so when initializing the model, we add a 'fake' root state, which\n        //makes the following operation safe.\n        this._configuration.add(this._model.initialRef);   \n\n        this._performBigStep();\n        return this.getConfiguration();\n    },\n\n    /**\n     * Starts the interpreter asynchronously\n     * @param  {Function} cb Callback invoked with an error or the interpreter's stable configuration\n     * @expose\n     */\n    startAsync : function(cb) {\n        if (typeof cb !== 'function') {\n            cb = nop;\n        }\n\n        this._log(\"performing initial big step\");\n\n        this._configuration.add(this._model.initialRef);\n\n        this._performBigStepAsync(null, cb);\n    },\n\n    /** @expose */\n    getConfiguration : function() {\n        return this._configuration.iter().map(function(s){return s.id;});\n    },\n\n    /** @expose */\n    getFullConfiguration : function() {\n        return this._configuration.iter().\n                map(function(s){ return [s].concat(query.getAncestors(s));},this).\n                reduce(function(a,b){return a.concat(b);},[]).    //flatten\n                map(function(s){return s.id;}).\n                reduce(function(a,b){return a.indexOf(b) > -1 ? a : a.concat(b);},[]); //uniq\n    },\n\n\n    /** @expose */\n    isIn : function(stateName) {\n        return this.getFullConfiguration().indexOf(stateName) > -1;\n    },\n\n    /** @expose */\n    isFinal : function(stateName) {\n        return this._isInFinalState;\n    },\n\n    /** @private */\n    _performBigStep : function(e) {\n        this.emit('onBigStepBegin');\n        if (e) this._internalEventQueue.push(e);\n        var keepGoing = true;\n        while (keepGoing) {\n            var currentEvent = this._internalEventQueue.shift() || null;\n            var selectedTransitions  = this._selectTransitions(currentEvent, true);\n            if(selectedTransitions.isEmpty()){\n              selectedTransitions = this._selectTransitions(currentEvent, false);\n            }\n\n            this.emit('onSmallStepBegin', currentEvent);\n            this._performSmallStep(currentEvent, selectedTransitions);\n            this.emit('onSmallStepEnd', currentEvent);\n            keepGoing = !selectedTransitions.isEmpty();\n        }\n        this._isInFinalState = this._configuration.iter().every(function(s){ return s.typeEnum === STATE_TYPES.FINAL; });\n        this.emit('onBigStepEnd');\n    },\n\n    _performBigStepAsync : function(event, cb) {\n        if (event) {\n            this._internalEventQueue.push(event);\n        }\n\n        var self = this;\n        function doBigStep(eventToEmit) {\n            var selectedTransitions;\n            try {\n                self.emit(eventToEmit);\n                var currentEvent = self._internalEventQueue.shift() || null;\n                var selectedTransitions  = self._selectTransitions(currentEvent, true);\n                if(selectedTransitions.isEmpty()){\n                  selectedTransitions = self._selectTransitions(currentEvent, false);\n                }\n\n                self.emit('onSmallStepBegin', currentEvent);\n                self._performSmallStep(currentEvent, selectedTransitions);\n                self.emit('onSmallStepEnd', currentEvent);\n            } catch(err) {\n                cb(err);\n                return;\n            }\n\n            if (!selectedTransitions.isEmpty()) {\n                // keep going, but be nice (yield) to the process\n                // TODO: for compat with non-node, non-mozilla\n                // allow the context to provide the defer task function\n                self.emit('onBigStepSuspend');\n                setImmediate(doBigStep, 'onBigStepResume');\n            } else {\n                self._isInFinalState =\n                    self._configuration.iter().every(function(s) {\n                        return s.typeEnum === STATE_TYPES.FINAL;\n                    });\n                self.emit('onBigStepEnd');\n                cb(undefined, self.getConfiguration());\n            }\n        }\n\n        doBigStep('onBigStepBegin');\n    },\n\n    /** @private */\n    _performSmallStep : function(currentEvent, selectedTransitions) {\n\n        this._log(\"selecting transitions with currentEvent\", JSON.stringify(currentEvent));\n\n        this._log(\"selected transitions\", selectedTransitions);\n\n        if (!selectedTransitions.isEmpty()) {\n\n            this._log(\"sorted transitions\", selectedTransitions);\n\n            //we only want to enter and exit states from transitions with targets\n            //filter out targetless transitions here - we will only use these to execute transition actions\n            var selectedTransitionsWithTargets = new this.opts.Set(selectedTransitions.iter().filter(transitionWithTargets));\n\n            var exitedTuple = this._getStatesExited(selectedTransitionsWithTargets), \n                basicStatesExited = exitedTuple[0], \n                statesExited = exitedTuple[1];\n\n            var enteredTuple = this._getStatesEntered(selectedTransitionsWithTargets), \n                basicStatesEntered = enteredTuple[0], \n                statesEntered = enteredTuple[1];\n\n            this._log(\"basicStatesExited \", basicStatesExited);\n            this._log(\"basicStatesEntered \", basicStatesEntered);\n            this._log(\"statesExited \", statesExited);\n            this._log(\"statesEntered \", statesEntered);\n\n            var eventsToAddToInnerQueue = new this.opts.Set();\n\n            //update history states\n            this._log(\"executing state exit actions\");\n\n            for (var j = 0, len = statesExited.length; j < len; j++) {\n                var stateExited = statesExited[j];\n\n                this._log(\"exiting \", stateExited.id);\n\n                //invoke listeners\n                this.emit('onExit',stateExited.id)\n\n                if(stateExited.onExit !== undefined) {\n                    for (var exitIdx = 0, exitLen = stateExited.onExit.length; exitIdx < exitLen; exitIdx++) {\n                        this._evaluateAction(currentEvent, stateExited.onExit[exitIdx]);\n                    }\n                }\n\n                var f;\n                if (stateExited.historyRef) {\n                    if (stateExited.historyRef.isDeep) {\n                        f = function(s0) {\n                            return s0.typeEnum === STATE_TYPES.BASIC && stateExited.descendants.indexOf(s0) > -1;\n                        };\n                    } else {\n                        f = function(s0) {\n                            return s0.parent === stateExited;\n                        };\n                    }\n                    //update history\n                    this._historyValue[stateExited.historyRef.id] = statesExited.filter(f);\n                }\n            }\n\n            // -> Concurrency: Number of transitions: Multiple\n            // -> Concurrency: Order of transitions: Explicitly defined\n            var sortedTransitions = selectedTransitions.iter().sort(transitionComparator);\n\n            this._log(\"executing transitition actions\");\n\n\n            for (var stxIdx = 0, len = sortedTransitions.length; stxIdx < len; stxIdx++) {\n                var transition = sortedTransitions[stxIdx];\n\n                var targetIds = transition.targets && transition.targets.map(function(target){return target.id;});\n\n                this.emit('onTransition',transition.source.id,targetIds, stxIdx);\n\n                if(transition.onTransition !== undefined) {\n                    for (var txIdx = 0, txLen = transition.onTransition.length; txIdx < txLen; txIdx++) {\n                        this._evaluateAction(currentEvent, transition.onTransition[txIdx]);\n                    }\n                }\n            }\n \n            this._log(\"executing state enter actions\");\n\n            for (var enterIdx = 0, enterLen = statesEntered.length; enterIdx < enterLen; enterIdx++) {\n                var stateEntered = statesEntered[enterIdx];\n\n                this._log(\"entering\", stateEntered.id);\n\n                this.emit('onEntry',stateEntered.id);\n\n                if(stateEntered.onEntry !== undefined) {\n                    for (var entryIdx = 0, entryLen = stateEntered.onEntry.length; entryIdx < entryLen; entryIdx++) {\n                        this._evaluateAction(currentEvent, stateEntered.onEntry[entryIdx]);\n                    }\n                }\n            }\n\n            this._log(\"updating configuration \");\n            this._log(\"old configuration \", this._configuration);\n\n            //update configuration by removing basic states exited, and adding basic states entered\n            this._configuration.difference(basicStatesExited);\n            this._configuration.union(basicStatesEntered);\n\n\n            this._log(\"new configuration \", this._configuration);\n            \n            //add set of generated events to the innerEventQueue -> Event Lifelines: Next small-step\n            if (!eventsToAddToInnerQueue.isEmpty()) {\n                this._log(\"adding triggered events to inner queue \", eventsToAddToInnerQueue);\n                this._internalEventQueue.push(eventsToAddToInnerQueue);\n            }\n\n        }\n\n        //if selectedTransitions is empty, we have reached a stable state, and the big-step will stop, otherwise will continue -> Maximality: Take-Many\n        return selectedTransitions;\n    },\n\n    /** @private */\n    _evaluateAction : function(currentEvent, actionRef) {\n        try {\n          return actionRef.call(this._scriptingContext, currentEvent);     //SCXML system variables\n        } catch (e){\n          var err = {\n            tagname: actionRef.tagname, \n            line: actionRef.line, \n            column: actionRef.column,\n            reason: e.message\n          }\n          this._internalEventQueue.push({\"name\":\"error.execution\",data : err});\n          this.emit('onError', err);\n        }\n    },\n\n    /** @private */\n    _getStatesExited : function(transitions) {\n        var statesExited = new this.opts.Set();\n        var basicStatesExited = new this.opts.Set();\n\n        //States exited are defined to be active states that are\n        //descendants of the scope of each priority-enabled transition.\n        //Here, we iterate through the transitions, and collect states\n        //that match this condition. \n        var transitionList = transitions.iter();\n        for (var txIdx = 0, txLen = transitionList.length; txIdx < txLen; txIdx++) {\n            var transition = transitionList[txIdx];\n            var scope = transition.scope,\n                desc = scope.descendants;\n\n            //For each state in the configuration\n            //is that state a descendant of the transition scope?\n            //Store ancestors of that state up to but not including the scope.\n            var configList = this._configuration.iter();\n            for (var cfgIdx = 0, cfgLen = configList.length; cfgIdx < cfgLen; cfgIdx++) {\n                var state = configList[cfgIdx];\n                if(desc.indexOf(state) > -1){\n                    basicStatesExited.add(state);\n                    statesExited.add(state);\n                    var ancestors = query.getAncestors(state,scope); \n                    for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) { \n                        statesExited.add(ancestors[ancIdx]);\n                    }\n                }\n            }\n        }\n\n        var sortedStatesExited = statesExited.iter().sort(getStateWithHigherSourceChildPriority);\n        return [basicStatesExited, sortedStatesExited];\n    },\n\n    /** @private */\n    _getStatesEntered : function(transitions) {\n\n        var o = {\n            statesToEnter : new this.opts.Set(),\n            basicStatesToEnter : new this.opts.Set(),\n            statesProcessed  : new this.opts.Set(),\n            statesToProcess : []\n        };\n\n        //do the initial setup\n        var transitionList = transitions.iter();\n        for (var txIdx = 0, txLen = transitionList.length; txIdx < txLen; txIdx++) {\n            var transition = transitionList[txIdx];\n            for (var targetIdx = 0, targetLen = transition.targets.length; targetIdx < targetLen; targetIdx++) {\n                this._addStateAndAncestors(transition.targets[targetIdx],transition.scope,o);\n            }\n        }\n\n        //loop and add states until there are no more to add (we reach a stable state)\n        var s;\n        /*jsl:ignore*/\n        while(s = o.statesToProcess.pop()){\n            /*jsl:end*/\n            this._addStateAndDescendants(s,o);\n        }\n\n        //sort based on depth\n        var sortedStatesEntered = o.statesToEnter.iter().sort(\n          function(s1, s2){\n            return getStateWithHigherSourceChildPriority(s1, s2) * -1\n          });\n\n        return [o.basicStatesToEnter, sortedStatesEntered];\n    },\n\n    /** @private */\n    _addStateAndAncestors : function(target,scope,o){\n\n        //process each target\n        this._addStateAndDescendants(target,o);\n\n        //and process ancestors of targets up to the scope, but according to special rules\n        var ancestors = query.getAncestors(target,scope);\n        for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) {\n            var s = ancestors[ancIdx];\n            if (s.typeEnum === STATE_TYPES.COMPOSITE) {\n                //just add him to statesToEnter, and declare him processed\n                //this is to prevent adding his initial state later on\n                o.statesToEnter.add(s);\n\n                o.statesProcessed.add(s);\n            }else{\n                //everything else can just be passed through as normal\n                this._addStateAndDescendants(s,o);\n            } \n        }\n    },\n\n    /** @private */\n    _addStateAndDescendants : function(s,o){\n\n        if(o.statesProcessed.contains(s)) return;\n\n        if (s.typeEnum === STATE_TYPES.HISTORY) {\n            if (s.id in this._historyValue) {\n                this._historyValue[s.id].forEach(function(stateFromHistory){\n                    this._addStateAndAncestors(stateFromHistory,s.parent,o);\n                },this);\n            } else {\n                o.statesToEnter.add(s);\n                o.basicStatesToEnter.add(s);\n            }\n        } else {\n            o.statesToEnter.add(s);\n\n            if (s.typeEnum === STATE_TYPES.PARALLEL) {\n                o.statesToProcess.push.apply(o.statesToProcess,\n                    s.states.filter(function(s){return s.typeEnum !== STATE_TYPES.HISTORY;}));\n            } else if (s.typeEnum === STATE_TYPES.COMPOSITE) {\n                o.statesToProcess.push(s.initialRef); \n            } else if (s.typeEnum === STATE_TYPES.INITIAL || s.typeEnum === STATE_TYPES.BASIC || s.typeEnum === STATE_TYPES.FINAL) {\n                o.basicStatesToEnter.add(s);\n            }\n        }\n\n        o.statesProcessed.add(s); \n    },\n\n    /** @private */\n    _selectTransitions : function(currentEvent, selectEventlessTransitions) {\n        if (this.opts.onlySelectFromBasicStates) {\n            var states = this._configuration.iter();\n        } else {\n            var statesAndParents = new this.opts.Set;\n\n            //get full configuration, unordered\n            //this means we may select transitions from parents before states\n            var configList = this._configuration.iter();\n            for (var idx = 0, len = configList.length; idx < len; idx++) {\n                var basicState = configList[idx];\n                statesAndParents.add(basicState);\n                var ancestors = query.getAncestors(basicState);\n                for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) {\n                    statesAndParents.add(ancestors[ancIdx]);\n                }\n            }\n\n            states = statesAndParents.iter();\n        }\n\n        var transitionSelector = this.opts.transitionSelector;\n        var enabledTransitions = new this.opts.Set();\n\n        var e = this._evaluateAction.bind(this,currentEvent);\n\n        for (var stateIdx = 0, stateLen = states.length; stateIdx < stateLen; stateIdx++) {\n            var transitions = transitionSelector(states[stateIdx], currentEvent, e, selectEventlessTransitions);\n            for (var txIdx = 0, len = transitions.length; txIdx < len; txIdx++) {\n                enabledTransitions.add(transitions[txIdx]);\n            }\n        }\n\n        var priorityEnabledTransitions = this._selectPriorityEnabledTransitions(enabledTransitions);\n\n        this._log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n        \n        return priorityEnabledTransitions;\n    },\n\n    /** @private */\n    _selectPriorityEnabledTransitions : function(enabledTransitions) {\n        var priorityEnabledTransitions = new this.opts.Set();\n\n        var tuple = this._getInconsistentTransitions(enabledTransitions), \n            consistentTransitions = tuple[0], \n            inconsistentTransitionsPairs = tuple[1];\n\n        priorityEnabledTransitions.union(consistentTransitions);\n\n        this._log(\"enabledTransitions\", enabledTransitions);\n        this._log(\"consistentTransitions\", consistentTransitions);\n        this._log(\"inconsistentTransitionsPairs\", inconsistentTransitionsPairs);\n        this._log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n        \n        while (!inconsistentTransitionsPairs.isEmpty()) {\n            enabledTransitions = new this.opts.Set(\n                    inconsistentTransitionsPairs.iter().map(function(t){return this.opts.priorityComparisonFn(t);},this));\n\n            tuple = this._getInconsistentTransitions(enabledTransitions);\n            consistentTransitions = tuple[0]; \n            inconsistentTransitionsPairs = tuple[1];\n\n            priorityEnabledTransitions.union(consistentTransitions);\n\n            this._log(\"enabledTransitions\", enabledTransitions);\n            this._log(\"consistentTransitions\", consistentTransitions);\n            this._log(\"inconsistentTransitionsPairs\", inconsistentTransitionsPairs);\n            this._log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n            \n        }\n        return priorityEnabledTransitions;\n    },\n\n    /** @private */\n    _getInconsistentTransitions : function(transitions) {\n        var allInconsistentTransitions = new this.opts.Set();\n        var inconsistentTransitionsPairs = new this.opts.Set();\n        var transitionList = transitions.iter();\n\n        this._log(\"transitions\", transitions);\n\n        for(var i = 0; i < transitionList.length; i++){\n            for(var j = i+1; j < transitionList.length; j++){\n                var t1 = transitionList[i];\n                var t2 = transitionList[j];\n                if (this._conflicts(t1, t2)) {\n                    allInconsistentTransitions.add(t1);\n                    allInconsistentTransitions.add(t2);\n                    inconsistentTransitionsPairs.add([t1, t2]);\n                }\n            }\n        }\n\n        var consistentTransitions = transitions.difference(allInconsistentTransitions);\n        return [consistentTransitions, inconsistentTransitionsPairs];\n    },\n\n    _log : function(){\n      if(printTrace){\n        var args = Array.from(arguments);\n        this.opts.console.log( \n          `${args[0]}: ${\n            args.slice(1).map(function(arg){\n              return arg === null ? 'null' : \n                ( arg === undefined ? 'undefined' : \n                  ( typeof arg === 'string' ? arg : \n                    ( arg.__proto__ === Object.prototype ? JSON.stringify(arg) : arg.toString())));\n\n            }).join(', ')\n          }\\n`\n        );\n      }\n    },\n\n    /** @private */\n    _conflicts : function(t1, t2) {\n        return !this._isArenaOrthogonal(t1, t2);\n    },\n\n    /** @private */\n    _isArenaOrthogonal : function(t1, t2) {\n\n        this._log(\"transition scopes\", t1.scope, t2.scope);\n\n        var isOrthogonal = query.isOrthogonalTo(t1.scope, t2.scope);\n\n        this._log(\"transition scopes are orthogonal?\", isOrthogonal);\n\n        return isOrthogonal;\n    },\n\n\n    /*\n        registerListener provides a generic mechanism to subscribe to state change and runtime error notifications.\n        Can be used for logging and debugging. For example, can attach a logger that simply logs the state changes.\n        Or can attach a network debugging client that sends state change notifications to a debugging server.\n    \n        listener is of the form:\n        {\n          onEntry : function(stateId){},\n          onExit : function(stateId){},\n          onTransition : function(sourceStateId,targetStatesIds[]){},\n          onError: function(errorInfo){},\n          onBigStepBegin: function(){},\n          onBigStepResume: function(){},\n          onBigStepSuspend: function(){},\n          onBigStepEnd: function(){}\n          onSmallStepBegin: function(event){},\n          onSmallStepEnd: function(){}\n        }\n    */\n    //TODO: refactor this to be event emitter? \n\n    /** @expose */\n    registerListener : function(listener){\n        BaseInterpreter.EVENTS.forEach(function(event){\n          if(listener[event]) this.on(event,listener[event]);\n        }, this);\n    },\n\n    /** @expose */\n    unregisterListener : function(listener){\n        BaseInterpreter.EVENTS.forEach(function(event){\n          if(listener[event]) this.off(event,listener[event]);\n        }, this);\n    },\n\n    /** @expose */\n    getAllTransitionEvents : function(){\n        var events = {};\n        function getEvents(state){\n\n            if(state.transitions){\n                for (var txIdx = 0, txLen = state.transitions.length; txIdx < txLen; txIdx++) {\n                    events[state.transitions[txIdx].event] = true;\n                }\n            }\n\n            if(state.states) {\n                for (var stateIdx = 0, stateLen = state.states.length; stateIdx < stateLen; stateIdx++) {\n                    getEvents(state.states[stateIdx]);\n                }\n            }\n        }\n\n        getEvents(this._model);\n\n        return Object.keys(events);\n    },\n\n    \n    /** @expose */\n    /**\n      Three things capture the current snapshot of a running SCION interpreter:\n\n      * basic configuration (the set of basic states the state machine is in)\n      * history state values (the states the state machine was in last time it was in the parent of a history state)\n      * the datamodel\n      \n      Note that this assumes that the method to serialize a scion.SCXML\n      instance is not called when the interpreter is executing a big-step (e.g. after\n      scion.SCXML.prototype.gen is called, and before the call to gen returns). If\n      the serialization method is called during the execution of a big-step, then the\n      inner event queue must also be saved. I do not expect this to be a common\n      requirement however, and therefore I believe it would be better to only support\n      serialization when the interpreter is not executing a big-step.\n    */\n    getSnapshot : function(){\n      if(this._isStepping) throw new Error('getSnapshot cannot be called while interpreter is executing a big-step');\n\n\n      return [\n        this.getConfiguration(),\n        this._serializeHistory(),\n        this._isInFinalState,\n        this._model.$serializeDatamodel()\n      ];\n    },\n\n    _serializeHistory : function(){\n      var o = {};\n      Object.keys(this._historyValue).forEach(function(sid){\n        o[sid] = this._historyValue[sid].map(function(state){return state.id});\n      },this);\n      return o;\n    }\n});\n\n/**\n * @constructor\n * @extends BaseInterpreter\n */\nfunction Statechart(model, opts) {\n    opts = opts || {};\n\n    opts.ioprocessors = {};\n\n    //Create all supported Event I/O processor nodes.\n    //TODO fix location after implementing actual processors\n    for (var processorType in ioProcessorTypes) {\n        opts.ioprocessors[processorType] = ioProcessorTypes[processorType];\n    }\n\n    opts.InterpreterScriptingContext = opts.InterpreterScriptingContext || InterpreterScriptingContext;\n\n    this._isStepping = false;\n\n    BaseInterpreter.call(this,model,opts);     //call super constructor\n}\n\nfunction beget(o){\n    function F(){}\n    F.prototype = o;\n    return new F();\n}\n\n/**\n * Do nothing\n */\nfunction nop() {}\n\n//Statechart.prototype = Object.create(BaseInterpreter.prototype);\n//would like to use Object.create here, but not portable, but it's too complicated to use portably\nStatechart.prototype = beget(BaseInterpreter.prototype);    \n\n/** @expose */\nStatechart.prototype.gen = function(evtObjOrName,optionalData) {\n\n    var currentEvent;\n    switch(typeof evtObjOrName){\n        case 'string':\n            currentEvent = {name : evtObjOrName, data : optionalData};\n            break;\n        case 'object':\n            if(typeof evtObjOrName.name === 'string'){\n                currentEvent = evtObjOrName;\n            }else{\n                throw new Error('Event object must have \"name\" property of type string.');\n            }\n            break;\n        default:\n            throw new Error('First argument to gen must be a string or object.');\n    }\n\n    if(this._isStepping) throw new Error('Cannot call gen during a big-step');\n\n    //otherwise, kick him off\n    this._isStepping = true;\n\n    this._performBigStep(currentEvent);\n\n    this._isStepping = false;\n    return this.getConfiguration();\n};\n\n/**\n * Injects an external event into the interpreter asynchronously\n * @param  {object}   currentEvent The event to inject\n * @param {string} currentEvent.name The name of the event\n * @param {string} [currentEvent.data] The event data\n * @param  {Function} cb Callback invoked with an error or the interpreter's stable configuration\n * @expose\n */\nStatechart.prototype.genAsync = function(currentEvent, cb) {\n    if (typeof currentEvent !== 'object' || !currentEvent || typeof currentEvent.name !== 'string') {\n        throw new Error('expected currentEvent to be an Object with a name');\n    }\n\n    if(this._isStepping) {\n        throw new Error('Cannot call gen during a big-step');\n    }\n\n    if (typeof cb !== 'function') {\n        cb = nop;\n    }\n\n    this._isStepping = true;\n\n    var self = this;\n    this._performBigStepAsync(currentEvent, function(err, config) {\n        self._isStepping = false;\n        cb(err, config);\n    });\n};\n\nfunction InterpreterScriptingContext(interpreter) {\n    this._interpreter = interpreter;\n    this._timeoutMap = {};\n}\n\n//Regex from:\n//  http://daringfireball.net/2010/07/improved_regex_for_matching_urls\n//  http://stackoverflow.com/a/6927878\nvar validateUriRegex = /\\b((?:[a-z][\\w-]+:(?:\\/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}\\/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))/i;\n\n//TODO: consider whether this is the API we would like to expose\nInterpreterScriptingContext.prototype = {\n    raise : function(event){\n        this._interpreter._internalEventQueue.push(event); \n    },\n    send : function(event, options){\n        //TODO: move these out\n        function validateSend(event, options, sendAction){\n          if(event.target){\n            var targetIsValidUri = validateUriRegex.test(event.target)\n            if(!targetIsValidUri){\n              return this.raise({ name : \"error.execution\", data: 'Target is not valid URI', sendid: options.sendid });\n            }\n          }\n\n          var eventProcessorTypes = Object.keys(ioProcessorTypes).map(function(k){return ioProcessorTypes[k].location});\n          if(eventProcessorTypes.indexOf(event.type) === -1) {\n              return this.raise({ name : \"error.execution\", data: 'Unsupported event processor type', sendid: options.sendid });\n          }\n\n          sendAction.call(this, event, options);\n        }\n\n        function defaultSendAction (event, options) {\n\n          if( typeof setTimeout === 'undefined' ) throw new Error('Default implementation of Statechart.prototype.send will not work unless setTimeout is defined globally.');\n\n          var timeoutId = setTimeout(this._interpreter.gen.bind(this._interpreter, event), options.delay || 0);\n\n          if (options.sendid) this._timeoutMap[options.sendid] = timeoutId;\n        }\n\n        function publish(){\n          this._interpreter.emit(event.name,event.data);\n        }\n\n        event.type = event.type || ioProcessorTypes.scxml.location;\n\n        //choose send function\n        var sendFn;\n        if(event.type === 'https://github.com/jbeard4/SCION#publish'){\n          sendFn = publish;\n        }else if(this._interpreter.opts.customSend){\n          sendFn = this._interpreter.opts.customSend;\n        }else{\n          sendFn = defaultSendAction;\n        }\n\n        options=options || {};\n\n        this._interpreter._log(\"sending event\", event.name, \"with content\", event.data, \"after delay\", options.delay);\n\n        validateSend.call(this, event, options, sendFn);\n    },\n    cancel : function(sendid){\n        if(this._interpreter.opts.customCancel) {\n            return this._interpreter.opts.customCancel.apply(this, [sendid]);\n        }\n\n        if( typeof clearTimeout === 'undefined' ) throw new Error('Default implementation of Statechart.prototype.cancel will not work unless setTimeout is defined globally.');\n\n        if (sendid in this._timeoutMap) {\n            this._interpreter._log(\"cancelling \", sendid, \" with timeout id \", this._timeoutMap[sendid]);\n            clearTimeout(this._timeoutMap[sendid]);\n        }\n    }\n};\n\nmodule.exports = {\n    /** @expose */\n    BaseInterpreter: BaseInterpreter,\n    /** @expose */\n    Statechart: Statechart,\n    /** @expose */\n    ArraySet : ArraySet,\n    /** @expose */\n    STATE_TYPES : STATE_TYPES,\n    /** @expose */\n    initializeModel : initializeModel,\n    /** @expose */\n    InterpreterScriptingContext : InterpreterScriptingContext,\n    /** @expose */\n    ioProcessorTypes  : ioProcessorTypes \n};\n"]}