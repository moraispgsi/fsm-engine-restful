{"version":3,"sources":["../lib/scion.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAcA,QAAI,SAAS,OAAO,MAAP,IACT,UAAU,EAAV,EAAc,IAAd,EAAmB;AACjB,eAAO,IAAP,CAAY,IAAZ,EAAkB,OAAlB,CAA0B,UAAS,CAAT,EAAW;AACnC,eAAG,CAAH,IAAQ,KAAK,CAAL,CAAR;AACD,SAFD;AAGA,eAAO,EAAP;AACD,KANL;;AAQA,QAAI,cAAc;AACd,eAAO,CADO;AAEd,mBAAW,CAFG;AAGd,kBAAU,CAHI;AAId,iBAAS,CAJK;AAKd,iBAAS,CALK;AAMd,eAAO;AANO,KAAlB;;AASA,QAAI,mBAAmB;AACnB,iBAAS;AACL,sBAAU;AADL,SADU;AAInB,qBAAa;AACT,sBAAU;AADD,SAJM;AAOnB,eAAO;AACH,sBAAU;AADP,SAPY;AAUnB,mBAAW;AACP,sBAAU;AADH;AAVQ,KAAvB;;AAeA,aAAS,qBAAT,CAA+B,CAA/B,EAAiC;AAC7B,eAAO,EAAE,OAAT;AACH;;AAED,aAAS,oBAAT,CAA8B,EAA9B,EAAkC,EAAlC,EAAsC;AAClC,eAAO,GAAG,aAAH,GAAmB,GAAG,aAA7B;AACH;;AAED,aAAS,eAAT,CAAyB,SAAzB,EAAmC;AAC/B,YAAI,cAAc,EAAlB;AAAA,YAAsB,eAAe,IAAI,GAAJ,EAArC;AAAA,YAAgD,gBAAgB,CAAhE;;;;AAKA,YAAI,UAAU,EAAd;;AAEA,iBAAS,UAAT,CAAoB,IAApB,EAAyB;AACrB,gBAAG,QAAQ,IAAR,MAAkB,SAArB,EAAgC,QAAQ,IAAR,IAAgB,CAAhB;;AAEhC,gBAAI,QAAQ,QAAQ,IAAR,GAAZ;AACA,mBAAO,gBAAgB,IAAhB,GAAuB,GAAvB,GAA6B,KAApC;AACH;;AAED,iBAAS,mBAAT,CAA6B,KAA7B,EAAmC;AAC/B,mBAAO;AACH,uCAAwB,MAAM,qBAAN,IAA+B,YAAU,CAAE,CADhE;AAEH,qCAAsB,MAAM,mBAAN,IAA6B,YAAU;AAAE,2BAAO,IAAP;AAAa,iBAFzE;AAGH,+BAAgB,YAHb,E;AAIH,wBAAS,CACL;AACI,2BAAQ,SADZ;AAEI,iCAAc,CAAC;AACX,gCAAS;AADE,qBAAD;AAFlB,iBADK,EAOL,KAPK;AAJN,aAAP;AAcH;;AAED,YAAI,8BAA8B,EAAlC;;AAEA,iBAAS,kBAAT,CAA4B,WAA5B,EAAwC;AACtC,mBAAU,WAAV,aAA4B,KAAK,MAAL,GAAc,MAAM,KAAK,MAAL,CAAY,IAAZ,CAAiB,GAAjB,CAAN,GAA8B,GAA5C,GAAkD,IAA9E,KAAqF,KAAK,IAAL,GAAY,MAAM,KAAK,IAAL,CAAU,IAAhB,GAAuB,GAAnC,GAAyC,EAA9H,eAAwI,KAAK,OAAL,GAAe,KAAK,OAAL,CAAa,IAAb,CAAkB,GAAlB,CAAf,GAAwC,IAAhL;AACD;;AAED,iBAAS,aAAT,GAAwB;AACtB,mBAAO,KAAK,EAAZ;AACD;;AAED,iBAAS,QAAT,CAAkB,SAAlB,EAA4B,KAA5B,EAAkC;;AAE9B,gBAAG,UAAH,EAAe,MAAM,QAAN,GAAiB,aAAjB;;;AAGf,gBAAG,MAAM,WAAT,EAAsB,YAAY,IAAZ,CAAiB,KAAjB,CAAuB,WAAvB,EAAmC,MAAM,WAAzC;;;AAGtB,gBAAG,MAAM,EAAT,EAAY;AACR,oBAAG,aAAa,GAAb,CAAiB,MAAM,EAAvB,CAAH,EAA+B,MAAM,IAAI,KAAJ,CAAU,8BAA8B,MAAM,EAA9C,CAAN;;AAE/B,6BAAa,GAAb,CAAiB,MAAM,EAAvB,EAA2B,KAA3B;AACH;;;;AAID,kBAAM,KAAN,GAAc,MAAM,KAAN,IAAe,OAA7B;;;AAGA,kBAAM,SAAN,GAAkB,SAAlB;AACA,kBAAM,KAAN,GAAc,UAAU,MAAxB;AACA,kBAAM,MAAN,GAAe,UAAU,CAAV,CAAf;AACA,kBAAM,aAAN,GAAsB,eAAtB;;;AAGA,kBAAM,WAAN,GAAoB,MAAM,WAAN,IAAqB,EAAzC;AACA,iBAAK,IAAI,IAAI,CAAR,EAAW,MAAM,MAAM,WAAN,CAAkB,MAAxC,EAAgD,IAAI,GAApD,EAAyD,GAAzD,EAA8D;AAC1D,oBAAI,aAAa,MAAM,WAAN,CAAkB,CAAlB,CAAjB;AACA,2BAAW,aAAX,GAA2B,eAA3B;AACA,2BAAW,MAAX,GAAoB,KAApB;AACA,oBAAG,UAAH,EAAe,WAAW,QAAX,GAAsB,mBAAmB,IAAnB,CAAwB,UAAxB,EAAoC,KAApC,CAAtB;AAClB;;;AAGD,gBAAG,MAAM,MAAT,EAAiB;AACb,oBAAI,OAAO,CAAC,KAAD,EAAQ,MAAR,CAAe,SAAf,CAAX;AACA,qBAAK,IAAI,IAAI,CAAR,EAAW,MAAM,MAAM,MAAN,CAAa,MAAnC,EAA2C,IAAI,GAA/C,EAAoD,GAApD,EAAyD;AACrD,6BAAS,IAAT,EAAe,MAAM,MAAN,CAAa,CAAb,CAAf;AACH;AACJ;;;AAGD,oBAAO,MAAM,KAAb;AACI,qBAAK,UAAL;AACI,0BAAM,QAAN,GAAiB,YAAY,QAA7B;AACA;AACJ,qBAAK,SAAL;AACI,0BAAM,QAAN,GAAiB,YAAY,OAA7B;AACA;AACJ,qBAAK,SAAL;AACI,0BAAM,QAAN,GAAiB,YAAY,OAA7B;AACA;AACJ,qBAAK,OAAL;AACI,0BAAM,QAAN,GAAiB,YAAY,KAA7B;AACA;AACJ,qBAAK,OAAL;AACA,qBAAK,OAAL;AACI,wBAAG,MAAM,MAAN,IAAgB,MAAM,MAAN,CAAa,MAAhC,EAAuC;AACnC,8BAAM,QAAN,GAAiB,YAAY,SAA7B;AACH,qBAFD,MAEK;AACD,8BAAM,QAAN,GAAiB,YAAY,KAA7B;AACH;AACD;AACJ;AACI,0BAAM,IAAI,KAAJ,CAAU,yBAAyB,MAAM,KAAzC,CAAN;AAtBR;;;AA0BA,gBAAG,MAAM,MAAT,EAAgB;AACZ,sBAAM,WAAN,GAAoB,MAAM,MAAN,CAAa,MAAb,CAAoB,MAAM,MAAN,CAAa,GAAb,CAAiB,UAAS,CAAT,EAAW;AAAC,2BAAO,EAAE,WAAT;AAAsB,iBAAnD,EAAqD,MAArD,CAA4D,UAAS,CAAT,EAAW,CAAX,EAAa;AAAC,2BAAO,EAAE,MAAF,CAAS,CAAT,CAAP;AAAoB,iBAA9F,EAA+F,EAA/F,CAApB,CAApB;AACH,aAFD,MAEK;AACD,sBAAM,WAAN,GAAoB,EAApB;AACH;;AAED,gBAAI,eAAJ;AACA,gBAAG,MAAM,QAAN,KAAmB,YAAY,SAAlC,EAA4C;;;AAGxC,oBAAG,OAAO,MAAM,OAAb,KAAyB,QAA5B,EAAqC;AACjC,gDAA4B,IAA5B,CAAiC,KAAjC;AACH,iBAFD,MAEK;;AAED,sCAAkB,MAAM,MAAN,CAAa,MAAb,CAAoB,UAAS,KAAT,EAAe;AACjD,+BAAO,MAAM,KAAN,KAAgB,SAAvB;AACH,qBAFiB,CAAlB;;AAIA,0BAAM,UAAN,GAAmB,gBAAgB,MAAhB,GAAyB,gBAAgB,CAAhB,CAAzB,GAA8C,MAAM,MAAN,CAAa,CAAb,CAAjE;AACA,oCAAgB,KAAhB;AACH;AAEJ;;;AAGD,gBAAG,MAAM,QAAN,KAAmB,YAAY,SAA/B,IACK,MAAM,QAAN,KAAmB,YAAY,QADvC,EACgD;;AAE5C,oBAAI,kBAAkB,MAAM,MAAN,CAAa,MAAb,CAAoB,UAAS,CAAT,EAAW;AACjD,2BAAO,EAAE,KAAF,KAAY,SAAnB;AACH,iBAFqB,CAAtB;;AAID,sBAAM,UAAN,GAAmB,gBAAgB,CAAhB,CAAnB;AACF;;;AAGD,gBAAG,CAAC,MAAM,EAAV,EAAa;AACT,sBAAM,EAAN,GAAW,WAAW,MAAM,KAAjB,CAAX;AACA,6BAAa,GAAb,CAAiB,MAAM,EAAvB,EAA2B,KAA3B;AACH;;;AAGD,gBAAI,MAAM,OAAN,IAAiB,CAAC,MAAM,OAAN,CAAc,MAAM,OAApB,CAAtB,EAAoD;AAChD,sBAAM,OAAN,GAAgB,CAAC,MAAM,OAAP,CAAhB;AACH;;AAED,gBAAI,MAAM,MAAN,IAAgB,CAAC,MAAM,OAAN,CAAc,MAAM,MAApB,CAArB,EAAkD;AAC9C,sBAAM,MAAN,GAAe,CAAC,MAAM,MAAP,CAAf;AACH;AACJ;;;;AAID,iBAAS,eAAT,CAAyB,KAAzB,EAA+B;AAC7B,gBAAG,CAAC,MAAM,UAAV,EAAsB,MAAM,IAAI,KAAJ,CAAU,yDAAyD,MAAM,EAAzE,CAAN;AACvB;AACD,iBAAS,uBAAT,GAAkC;AAChC,iBAAK,IAAI,IAAI,CAAR,EAAW,MAAM,4BAA4B,MAAlD,EAA0D,IAAI,GAA9D,EAAmE,GAAnE,EAAwE;AACtE,oBAAI,IAAI,4BAA4B,CAA5B,CAAR;AACA,kBAAE,UAAF,GAAe,aAAa,GAAb,CAAiB,EAAE,OAAnB,CAAf;AACA,gCAAgB,CAAhB;AACD;AACF;;AAED,YAAI,gBAAgB,KAApB;;AAEA,iBAAS,sBAAT,GAAiC;;AAE7B,iBAAK,IAAI,IAAI,CAAR,EAAW,MAAM,YAAY,MAAlC,EAA0C,IAAI,GAA9C,EAAmD,GAAnD,EAAwD;AACpD,oBAAI,IAAI,YAAY,CAAZ,CAAR;AACA,oBAAI,EAAE,YAAF,IAAkB,CAAC,MAAM,OAAN,CAAc,EAAE,YAAhB,CAAvB,EAAsD;AAClD,sBAAE,YAAF,GAAiB,CAAC,EAAE,YAAH,CAAjB;AACH;;;AAGD,oBAAI,OAAO,EAAE,KAAT,KAAmB,QAAvB,EAAiC;AAC7B,sBAAE,MAAF,GAAW,EAAE,KAAF,CAAQ,IAAR,GAAe,KAAf,CAAqB,aAArB,CAAX;AACH;AACD,uBAAO,EAAE,KAAT;;AAEA,oBAAG,EAAE,OAAF,IAAc,OAAO,EAAE,MAAT,KAAoB,WAArC,EAAmD;;AAE/C;AACH;;AAED,oBAAG,OAAO,EAAE,MAAT,KAAoB,QAAvB,EAAgC;AAC5B,wBAAI,SAAS,aAAa,GAAb,CAAiB,EAAE,MAAnB,CAAb;AACA,wBAAG,CAAC,MAAJ,EAAY,MAAM,IAAI,KAAJ,CAAU,yCAAyC,EAAE,MAArD,CAAN;AACZ,sBAAE,MAAF,GAAW,MAAX;AACA,sBAAE,OAAF,GAAY,CAAC,EAAE,MAAH,CAAZ;AACH,iBALD,MAKM,IAAG,MAAM,OAAN,CAAc,EAAE,MAAhB,CAAH,EAA2B;AAC7B,sBAAE,OAAF,GAAY,EAAE,MAAF,CAAS,GAAT,CAAa,UAAS,MAAT,EAAgB;AACrC,4BAAG,OAAO,MAAP,KAAkB,QAArB,EAA8B;AAC1B,qCAAS,aAAa,GAAb,CAAiB,MAAjB,CAAT;AACA,gCAAG,CAAC,MAAJ,EAAY,MAAM,IAAI,KAAJ,CAAU,yCAAyC,EAAE,MAArD,CAAN;AACZ,mCAAO,MAAP;AACH,yBAJD,MAIK;AACD,mCAAO,MAAP;AACH;AACJ,qBARW,CAAZ;AASH,iBAVK,MAUA,IAAG,QAAO,EAAE,MAAT,MAAoB,QAAvB,EAAgC;AAClC,sBAAE,OAAF,GAAY,CAAC,EAAE,MAAH,CAAZ;AACH,iBAFK,MAED;AACD,0BAAM,IAAI,KAAJ,CAAU,yCAAyC,EAAE,MAArD,CAAN;AACH;AACJ;;;AAGD,iBAAK,IAAI,IAAI,CAAR,EAAW,MAAM,YAAY,MAAlC,EAA0C,IAAI,GAA9C,EAAmD,GAAnD,EAAwD;AACpD,oBAAI,IAAI,YAAY,CAAZ,CAAR;AACA,oBAAG,EAAE,OAAL,EAAc,EAAE,IAAF,GAAS,QAAQ,EAAE,MAAV,EAAiB,EAAE,OAAF,CAAU,CAAV,CAAjB,CAAT,C;;AAEd,kBAAE,KAAF,GAAU,SAAS,CAAT,CAAV;;AAEH;AACJ;;AAED,iBAAS,QAAT,CAAkB,UAAlB,EAA6B;;;;AAIzB,gBAAI,6BACI,WAAW,IAAX,KAAoB,UAApB,IACI,WAAW,MAAX,CAAkB,MADtB,I;AAEQ,uBAAW,OAFnB,I;AAGY,uBAAW,OAAX,CAAmB,KAAnB,CACI,UAAS,MAAT,EAAgB;AAAE,uBAAO,WAAW,MAAX,CAAkB,WAAlB,CAA8B,OAA9B,CAAsC,MAAtC,IAAgD,CAAC,CAAxD;AAA2D,aADjF,CAJpB;;AAOA,gBAAG,CAAC,WAAW,OAAf,EAAuB;AACnB,uBAAO,WAAW,MAAlB;AACH,aAFD,MAEM,IAAG,0BAAH,EAA8B;AAChC,uBAAO,WAAW,MAAlB;AACH,aAFK,MAED;AACD,uBAAO,WAAW,IAAlB;AACH;AACJ;;AAED,iBAAS,OAAT,CAAiB,EAAjB,EAAqB,EAArB,EAAyB;;AAErB,gBAAI,kBAAkB,EAAtB;AACA,iBAAK,IAAI,IAAI,CAAR,EAAW,MAAM,GAAG,SAAH,CAAa,MAAnC,EAA2C,IAAI,GAA/C,EAAoD,GAApD,EAAyD;AACrD,oBAAI,MAAM,GAAG,SAAH,CAAa,CAAb,CAAV;;AAEA,oBAAG,IAAI,QAAJ,KAAiB,YAAY,SAA7B,IACC,IAAI,WAAJ,CAAgB,OAAhB,CAAwB,EAAxB,IAA8B,CAAC,CADnC,EACqC;AACjC,oCAAgB,IAAhB,CAAqB,GAArB;AACH;AACJ;;AAED,gBAAG,CAAC,gBAAgB,MAApB,EAA4B,MAAM,IAAI,KAAJ,CAAU,gCAAV,CAAN;AAC5B,mBAAO,gBAAgB,CAAhB,CAAP;AACH;;;;AAID,YAAI,gBAAgB,oBAAoB,SAApB,CAApB,C;AACA,iBAAS,EAAT,EAAY,aAAZ;AACA;AACA;;AAEA,eAAO,aAAP;AACH;;;AAGD,aAAS,YAAT,GAAwB;AACpB,aAAK,UAAL,GAAkB,EAAlB;AACA,aAAK,UAAL,CAAgB,GAAhB,IAAuB,EAAvB;AACH;;AAED,iBAAa,SAAb,CAAuB,EAAvB,GAA4B,SAAS,GAAT,CAAa,IAAb,EAAmB,QAAnB,EAA6B;AACrD,YAAI,CAAC,MAAM,OAAN,CAAc,KAAK,UAAL,CAAgB,IAAhB,CAAd,CAAL,EAA2C;AACvC,iBAAK,UAAL,CAAgB,IAAhB,IAAwB,EAAxB;AACH;;AAED,YAAI,KAAK,UAAL,CAAgB,IAAhB,EAAsB,OAAtB,CAA8B,QAA9B,MAA4C,CAAC,CAAjD,EAAoD;AAChD,iBAAK,UAAL,CAAgB,IAAhB,EAAsB,IAAtB,CAA2B,QAA3B;AACH;;AAED,eAAO,IAAP;AACH,KAVD;;AAYA,iBAAa,SAAb,CAAuB,IAAvB,GAA8B,SAAS,KAAT,CAAe,IAAf,EAAqB,QAArB,EAA+B;AACzD,YAAI,OAAO,IAAX;;AAEA,iBAAS,MAAT,GAAkB;AACd,iBAAK,IAAI,OAAO,EAAX,EAAe,IAAI,CAAxB,EAA2B,IAAI,UAAU,MAAzC,EAAiD,KAAK,CAAtD,EAAyD;AACrD,qBAAK,CAAL,IAAU,UAAU,CAAV,CAAV;AACH;;AAED,iBAAK,GAAL,CAAS,IAAT,EAAe,MAAf;AACA,qBAAS,KAAT,CAAe,IAAf,EAAqB,IAArB;AACH;;AAED,eAAO,QAAP,GAAkB,QAAlB;;AAEA,eAAO,KAAK,EAAL,CAAQ,IAAR,EAAc,MAAd,CAAP;AACH,KAfD;;AAiBA,iBAAa,SAAb,CAAuB,GAAvB,GAA6B,SAAS,IAAT,CAAc,IAAd,EAAoB,QAApB,EAA8B;AACvD,YAAI,CAAC,MAAM,OAAN,CAAc,KAAK,UAAL,CAAgB,IAAhB,CAAd,CAAL,EAA2C;AACvC,mBAAO,IAAP;AACH;;AAED,YAAI,OAAO,QAAP,KAAoB,WAAxB,EAAqC;AACjC,iBAAK,UAAL,CAAgB,IAAhB,IAAwB,EAAxB;AACA,mBAAO,IAAP;AACH;;AAED,YAAI,QAAQ,KAAK,UAAL,CAAgB,IAAhB,EAAsB,OAAtB,CAA8B,QAA9B,CAAZ;;AAEA,YAAI,UAAU,CAAC,CAAf,EAAkB;AACd,iBAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,KAAK,UAAL,CAAgB,IAAhB,EAAsB,MAA1C,EAAkD,KAAK,CAAvD,EAA0D;AACtD,oBAAI,KAAK,UAAL,CAAgB,IAAhB,EAAsB,CAAtB,EAAyB,QAAzB,KAAsC,QAA1C,EAAoD;AAChD,4BAAQ,CAAR;AACA;AACH;AACJ;AACJ;;AAED,aAAK,UAAL,CAAgB,IAAhB,EAAsB,MAAtB,CAA6B,KAA7B,EAAoC,CAApC;AACA,eAAO,IAAP;AACH,KAvBD;;AAyBA,iBAAa,SAAb,CAAuB,IAAvB,GAA8B,SAAS,KAAT,CAAe,IAAf,EAAqB;;AAE/C,YAAI,OAAO,MAAM,SAAN,CAAgB,KAAhB,CAAsB,IAAtB,CAA2B,SAA3B,CAAX;AACA,YAAI,eAAe,KAAK,KAAL,CAAW,CAAX,CAAnB;;AAEA,YAAI,YAAY,KAAK,UAAL,CAAgB,IAAhB,CAAhB;AACA,YAAI,CAAJ,EAAO,GAAP;AACA,YAAI,MAAM,OAAN,CAAc,SAAd,CAAJ,EAA8B;AAC5B,iBAAK,IAAI,CAAJ,EAAO,MAAM,UAAU,MAA5B,EAAoC,IAAI,GAAxC,EAA6C,GAA7C,EAAkD;AAChD,0BAAU,CAAV,EAAa,KAAb,CAAmB,IAAnB,EAAyB,YAAzB;AACD;AACF;;;AAGD,oBAAY,KAAK,UAAL,CAAgB,GAAhB,CAAZ;AACA,aAAK,IAAI,CAAJ,EAAO,MAAM,UAAU,MAA5B,EAAoC,IAAI,GAAxC,EAA6C,GAA7C,EAAkD;AAC9C,sBAAU,CAAV,EAAa,KAAb,CAAmB,IAAnB,EAAyB,IAAzB;AACH;;AAED,eAAO,IAAP;AACH,KApBD;;;;;;;AA2BA,aAAS,QAAT,CAAkB,CAAlB,EAAqB;AACjB,YAAI,KAAK,EAAT;AACA,aAAK,CAAL,GAAS,IAAI,GAAJ,CAAQ,CAAR,CAAT;AACH;;AAED,aAAS,SAAT,GAAqB;;AAEjB,aAAM,aAAS,CAAT,EAAY;AACd,iBAAK,CAAL,CAAO,GAAP,CAAW,CAAX;AACH,SAJgB;;AAMjB,gBAAS,gBAAS,CAAT,EAAY;AACjB,mBAAO,KAAK,CAAL,CAAO,MAAP,CAAc,CAAd,CAAP;AACH,SARgB;;AAUjB,eAAQ,eAAS,CAAT,EAAY;AAAA;AAAA;AAAA;;AAAA;AAChB,qCAAc,EAAE,CAAhB,8HAAmB;AAAA,wBAAV,CAAU;;AACf,yBAAK,CAAL,CAAO,GAAP,CAAW,CAAX;AACH;AAHe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAIhB,mBAAO,IAAP;AACH,SAfgB;;AAiBjB,oBAAa,oBAAS,CAAT,EAAY;AAAA;AAAA;AAAA;;AAAA;AACrB,sCAAc,EAAE,CAAhB,mIAAmB;AAAA,wBAAV,CAAU;;AACf,yBAAK,CAAL,CAAO,MAAP,CAAc,CAAd;AACH;AAHoB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAIrB,mBAAO,IAAP;AACH,SAtBgB;;AAwBjB,kBAAW,kBAAS,CAAT,EAAY;AACnB,mBAAO,KAAK,CAAL,CAAO,GAAP,CAAW,CAAX,CAAP;AACH,SA1BgB;;AA4BjB,cAAO,gBAAW;AACd,mBAAO,MAAM,IAAN,CAAW,KAAK,CAAhB,CAAP;AACH,SA9BgB;;AAgCjB,iBAAU,mBAAW;AACjB,mBAAO,CAAC,KAAK,CAAL,CAAO,IAAf;AACH,SAlCgB;;AAoCjB,cAAM,gBAAW;AACb,mBAAO,KAAK,CAAL,CAAO,IAAd;AACH,SAtCgB;;AAwCjB,gBAAS,gBAAS,EAAT,EAAa;AAClB,gBAAI,KAAK,CAAL,CAAO,IAAP,KAAgB,GAAG,IAAH,EAApB,EAA+B;AAC3B,uBAAO,KAAP;AACH;;AAHiB;AAAA;AAAA;;AAAA;AAKlB,sCAAc,KAAK,CAAnB,mIAAsB;AAAA,wBAAb,CAAa;;AAClB,wBAAI,CAAC,GAAG,QAAH,CAAY,CAAZ,CAAL,EAAqB;AACjB,+BAAO,KAAP;AACH;AACJ;AATiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAWlB,mBAAO,IAAP;AACH,SApDgB;;AAsDjB,kBAAW,oBAAW;AAClB,mBAAO,KAAK,CAAL,CAAO,IAAP,KAAgB,CAAhB,GAAoB,SAApB,GAAgC,MAAM,IAAN,CAAW,KAAK,CAAhB,EAAmB,IAAnB,CAAwB,KAAxB,CAAvC;AACH;AAxDgB,KAArB;;AA2DA,QAAM,uBAAuB,OAA7B;;AAEA,aAAS,kBAAT,CAA4B,MAA5B,EAAoC,QAApC,EAA8C;AAC1C,iBAAS,OAAO,OAAP,CAAe,oBAAf,EAAqC,EAArC,CAAT;;AAEA,YAAI,WAAW,QAAf,EAAyB;AACrB,mBAAO,IAAP;AACH;;AAED,YAAI,OAAO,MAAP,GAAgB,SAAS,MAA7B,EAAqC;AACjC,mBAAO,KAAP;AACH;;AAED,YAAI,SAAS,MAAT,CAAgB,OAAO,MAAvB,MAAmC,GAAvC,EAA4C;AACxC,mBAAO,KAAP;AACH;;AAED,eAAQ,SAAS,OAAT,CAAiB,MAAjB,MAA6B,CAArC;AACH;;AAED,aAAS,iBAAT,CAA2B,CAA3B,EAA8B,SAA9B,EAAyC;AACrC,eAAO,EAAE,MAAF,CAAS,IAAT,CAAc,UAAC,MAAD,EAAY;AAC7B,mBAAO,WAAW,GAAX,IAAkB,mBAAmB,MAAnB,EAA2B,SAA3B,CAAzB;AACH,SAFM,CAAP;AAGH;;AAED,aAAS,6BAAT,CAAuC,KAAvC,EAA8C,KAA9C,EAAqD,SAArD,EAAgE,0BAAhE,EAA4F;AACxF,eAAO,MAAM,WAAN,CAAkB,MAAlB,CAAyB,UAAC,CAAD,EAAO;AACnC,mBAAO,CACL,6BACE,CAAC,EAAE,MADL,GAEG,CAAC,EAAE,MAAH,IAAc,SAAS,MAAM,IAAf,IAAuB,kBAAkB,CAAlB,EAAqB,MAAM,IAA3B,CAHnC,MAKD,CAAC,EAAE,IAAH,IAAW,UAAU,EAAE,IAAZ,CALV,CAAP;AAMH,SAPM,CAAP;AAQH;;AAED,aAAS,2BAAT,CAAqC,KAArC,EAA2C;AACzC,eAAO,MAAM,WAAN,CAAkB,MAAlB,CAAyB,UAAS,UAAT,EAAoB;AAAE,mBAAO,CAAC,WAAW,MAAZ,IAAwB,WAAW,MAAX,IAAqB,WAAW,MAAX,CAAkB,MAAlB,KAA6B,CAAjF;AAAuF,SAAtI,CAAP;AACD;;;AAGD,QAAI,QAAQ;AACR,sBAAc,sBAAS,CAAT,EAAY,IAAZ,EAAkB;AAC5B,gBAAI,SAAJ,EAAe,KAAf,EAAsB,KAAtB;AACA,oBAAQ,EAAE,SAAF,CAAY,OAAZ,CAAoB,IAApB,CAAR;AACA,gBAAI,QAAQ,CAAC,CAAb,EAAgB;AACZ,uBAAO,EAAE,SAAF,CAAY,KAAZ,CAAkB,CAAlB,EAAqB,KAArB,CAAP;AACH,aAFD,MAEO;AACH,uBAAO,EAAE,SAAT;AACH;AACJ,SATO;;AAWR,4BAAoB,4BAAS,CAAT,EAAY,IAAZ,EAAkB;AAClC,mBAAO,CAAC,CAAD,EAAI,MAAJ,CAAW,KAAK,YAAL,CAAkB,CAAlB,EAAqB,IAArB,CAAX,CAAP;AACH,SAbO;AAcR,8BAAsB,8BAAS,CAAT,EAAY;AAC9B,mBAAO,CAAC,CAAD,EAAI,MAAJ,CAAW,EAAE,WAAb,CAAP;AACH,SAhBO;;AAkBR,wBAAgB,wBAAS,EAAT,EAAa,EAAb,EAAiB;;;AAG7B,mBAAO,CAAC,KAAK,sBAAL,CAA4B,EAA5B,EAAgC,EAAhC,CAAD,IAAwC,KAAK,MAAL,CAAY,EAAZ,EAAgB,EAAhB,EAAoB,QAApB,KAAiC,YAAY,QAA5F;AACH,SAtBO;;AAwBR,gCAAwB,gCAAS,EAAT,EAAa,EAAb,EAAiB;;AAErC,mBAAO,KAAK,kBAAL,CAAwB,EAAxB,EAA4B,OAA5B,CAAoC,EAApC,IAA0C,CAAC,CAA3C,IAAgD,KAAK,kBAAL,CAAwB,EAAxB,EAA4B,OAA5B,CAAoC,EAApC,IAA0C,CAAC,CAAlG;AACH,SA3BO;;AA6BR,gBAAQ,gBAAS,EAAT,EAAa,EAAb,EAAiB;AACrB,gBAAI,kBAAkB,KAAK,YAAL,CAAkB,EAAlB,EAAsB,MAAtB,CAA6B,UAAS,CAAT,EAAW;AAC1D,uBAAO,EAAE,WAAF,CAAc,OAAd,CAAsB,EAAtB,IAA4B,CAAC,CAApC;AACH,aAFqB,EAEpB,IAFoB,CAAtB;AAGA,mBAAO,gBAAgB,CAAhB,CAAP;AACH;AAlCO,KAAZ;;;AAsCA,aAAS,0CAAT,OAA8D;AAAA;;AAAA,YAAT,EAAS;AAAA,YAAL,EAAK;;;AAE1D,YAAI,IAAI,sCAAsC,GAAG,MAAzC,EAAiD,GAAG,MAApD,CAAR;AACA,gBAAO,CAAP;AACE,iBAAK,CAAL;;AAEE,oBAAI,GAAG,aAAH,GAAmB,GAAG,aAA1B,EAAyC;AACrC,2BAAO,EAAP;AACH,iBAFD,MAEO;AACH,2BAAO,EAAP;AACH;AACH,iBAAK,CAAC,CAAN;AACE,uBAAO,EAAP;AACF,iBAAK,CAAL;AACE,uBAAO,EAAP;AACF;AACE,sBAAM,IAAI,KAAJ,CAAU,yBAAV,CAAN;AAbJ;AAeH;;AAED,aAAS,qCAAT,CAA+C,EAA/C,EAAmD,EAAnD,EAAuD;;AAEnD,gBAAQ,GAAR,CAAY,uCAAZ,EAAqD,GAAG,EAAxD,EAA4D,GAAG,KAA/D,EAAsE,GAAG,aAAzE,EAAwF,GAAG,EAA3F,EAA+F,GAAG,KAAlG,EAAyG,GAAG,aAA5G;AACA,YAAI,GAAG,KAAH,GAAW,GAAG,KAAlB,EAAyB;AACrB,mBAAO,CAAC,CAAR;AACH,SAFD,MAEO,IAAI,GAAG,KAAH,GAAW,GAAG,KAAlB,EAAyB;AAC5B,mBAAO,CAAP;AACH,SAFM,MAEA;;AAEH,gBAAI,GAAG,aAAH,GAAmB,GAAG,aAA1B,EAAyC;AACrC,uBAAO,CAAP;AACH,aAFD,MAEO,IAAI,GAAG,aAAH,GAAmB,GAAG,aAA1B,EAAyC;AAC5C,uBAAO,CAAC,CAAR;AACH,aAFM,MAED;AACF,uBAAO,CAAP;AACH;AACJ;AACJ;;AAED,aAAS,0BAAT,CAAoC,OAApC,EAA6C,IAA7C,EAAmD,WAAnD,EAA+D;;AAE1D,aAAK,CAAL,GAAU,KAAK,CAAL,IAAU,EAApB;;AAED,eAAO,QAAQ,IAAR,CAAa,WAAb,EACH,KAAK,CADF,EAEH,KAAK,SAFF,EAGH,KAAK,YAHF,EAIH,YAAY,IAAZ,CAAiB,IAAjB,CAAsB,WAAtB,CAJG,CAAP;AAKH;;AAED,aAAS,kCAAT,CAA4C,uBAA5C,EAAoE,YAApE,EAAiF;AAC/E,eAAO,wBAAwB,GAAxB,CAA4B,UAAS,EAAT,EAAY;AAC7C,gBAAI,QAAQ,aAAa,GAAb,CAAiB,EAAjB,CAAZ;AACA,gBAAG,CAAC,KAAJ,EAAW,MAAM,IAAI,KAAJ,CAAU,4EAA4E,EAAtF,CAAN;AACX,mBAAO,KAAP;AACD,SAJM,CAAP;AAKD;;AAED,aAAS,kBAAT,CAA4B,iBAA5B,EAA8C,YAA9C,EAA2D;AACzD,YAAI,IAAI,EAAR;AACA,eAAO,IAAP,CAAY,iBAAZ,EAA+B,OAA/B,CAAuC,UAAS,GAAT,EAAa;AAClD,cAAE,GAAF,IAAS,kBAAkB,GAAlB,EAAuB,GAAvB,CAA2B,UAAS,EAAT,EAAY;AAC9C,oBAAI,QAAQ,aAAa,GAAb,CAAiB,EAAjB,CAAZ;AACA,oBAAG,CAAC,KAAJ,EAAW,MAAM,IAAI,KAAJ,CAAU,sEAAsE,EAAhF,CAAN;AACX,uBAAO,KAAP;AACD,aAJQ,CAAT;AAKD,SAND;AAOA,eAAO,CAAP;AACD;;;AAGD,QAAI,aAAa,KAAjB;;AAEA,oBAAgB,MAAhB,GAAyB,CACvB,SADuB,EAEvB,QAFuB,EAGvB,cAHuB,EAIvB,SAJuB,EAKvB,gBALuB,EAMvB,kBANuB,EAOvB,iBAPuB,EAQvB,kBARuB,EASvB,gBATuB,EAUvB,cAVuB,CAAzB;;;AAcA,aAAS,eAAT,CAAyB,kBAAzB,EAA6C,IAA7C,EAAkD;;AAE9C,qBAAa,IAAb,CAAkB,IAAlB;;AAEA,aAAK,iBAAL,GAAyB,KAAK,2BAAL,KAAqC,KAAK,2BAAL,GAAmC,IAAI,KAAK,2BAAT,CAAqC,IAArC,CAAnC,GAAgF,EAArH,CAAzB;;AAEA,YAAI,KAAJ;AACA,YAAG,OAAO,kBAAP,KAA8B,UAAjC,EAA4C;AACxC,oBAAQ,2BAA2B,kBAA3B,EAA+C,IAA/C,EAAqD,IAArD,CAAR;AACH,SAFD,MAEM,IAAG,OAAO,kBAAP,KAA8B,QAAjC,EAA0C;AAC5C,oBAAQ,KAAK,KAAL,CAAW,kBAAX,CAAR;AACH,SAFK,MAED;AACD,oBAAQ,kBAAR;AACH;;AAED,aAAK,MAAL,GAAc,gBAAgB,KAAhB,CAAd;;;;AAIA,aAAK,IAAL,GAAY,QAAQ,EAApB;;AAEA,aAAK,IAAL,CAAU,OAAV,GAAoB,KAAK,OAAL,KAAiB,OAAO,OAAP,KAAmB,WAAnB,GAAiC,EAAC,KAAM,eAAU,CAAE,CAAnB,EAAjC,GAAwD,OAAzE,CAApB,C;AACA,aAAK,IAAL,CAAU,GAAV,GAAgB,KAAK,IAAL,CAAU,GAAV,IAAiB,QAAjC;AACA,aAAK,IAAL,CAAU,oBAAV,GAAiC,KAAK,IAAL,CAAU,oBAAV,IAAkC,0CAAnE;AACA,aAAK,IAAL,CAAU,kBAAV,GAA+B,KAAK,IAAL,CAAU,kBAAV,IAAgC,6BAA/D;;AAEA,aAAK,iBAAL,CAAuB,GAAvB,GAA6B,KAAK,iBAAL,CAAuB,GAAvB,IAA+B,SAAS,GAAT,GAAc;AACxE,gBAAG,KAAK,IAAL,CAAU,OAAV,CAAkB,GAAlB,CAAsB,KAAzB,EAA+B;AAC7B,qBAAK,IAAL,CAAU,OAAV,CAAkB,GAAlB,CAAsB,KAAtB,CAA4B,KAAK,IAAL,CAAU,OAAtC,EAA+C,SAA/C;AACD,aAFD,MAEO;;AAEL,qBAAK,IAAL,CAAU,OAAV,CAAkB,GAAlB,CAAsB,MAAM,SAAN,CAAgB,KAAhB,CAAsB,KAAtB,CAA4B,SAA5B,EAAuC,IAAvC,CAA4C,GAA5C,CAAtB;AACD;AACF,SAP2D,CAO1D,IAP0D,CAOrD,IAPqD,CAA5D,C;;AASA,aAAK,mBAAL,GAA2B,EAA3B;;;AAGA,YAAG,KAAK,QAAR,EAAiB;AACf,iBAAK,cAAL,GAAsB,IAAI,KAAK,IAAL,CAAU,GAAd,CAAkB,mCAAmC,KAAK,QAAL,CAAc,CAAd,CAAnC,EAAqD,KAAK,MAAL,CAAY,aAAjE,CAAlB,CAAtB;AACA,iBAAK,aAAL,GAAqB,mBAAmB,KAAK,QAAL,CAAc,CAAd,CAAnB,EAAqC,KAAK,MAAL,CAAY,aAAjD,CAArB;AACA,iBAAK,eAAL,GAAuB,KAAK,QAAL,CAAc,CAAd,CAAvB;AACA,iBAAK,MAAL,CAAY,qBAAZ,CAAkC,KAAK,QAAL,CAAc,CAAd,CAAlC,E;AACD,SALD,MAKK;AACH,iBAAK,cAAL,GAAsB,IAAI,KAAK,IAAL,CAAU,GAAd,EAAtB;AACA,iBAAK,aAAL,GAAqB,EAArB;AACA,iBAAK,eAAL,GAAuB,KAAvB;AACD;;;AAGD,aAAK,EAAL,GAAU;AACN,wBAAa,KAAK,SAAL,IAAkB,IADzB;AAEN,mBAAQ,MAAM,IAAN,IAAc,KAAK,IAAnB,IAA2B,IAF7B;AAGN,2BAAgB,KAAK,YAAL,IAAqB;AAH/B,SAAV;;;AAOA,wBAAgB,MAAhB,CAAuB,OAAvB,CAA+B,UAAS,KAAT,EAAe;AAC5C,iBAAK,EAAL,CAAQ,KAAR,EAAe,KAAK,IAAL,CAAU,IAAV,CAAe,IAAf,EAAoB,KAApB,CAAf;AACD,SAFD,EAEG,IAFH;AAGH;;AAED,oBAAgB,SAAhB,GAA4B,OAAO,MAAM,aAAa,SAAnB,CAAP,EAAqC;;;AAG7D,eAAQ,iBAAW;;AAEf,iBAAK,IAAL,CAAU,6BAAV;;;;;AAKA,iBAAK,cAAL,CAAoB,GAApB,CAAwB,KAAK,MAAL,CAAY,UAApC;;AAEA,iBAAK,eAAL;AACA,mBAAO,KAAK,gBAAL,EAAP;AACH,SAd4D;;;;;;;AAqB7D,oBAAa,oBAAS,EAAT,EAAa;AACtB,gBAAI,OAAO,EAAP,KAAc,UAAlB,EAA8B;AAC1B,qBAAK,GAAL;AACH;;AAED,iBAAK,IAAL,CAAU,6BAAV;;AAEA,iBAAK,cAAL,CAAoB,GAApB,CAAwB,KAAK,MAAL,CAAY,UAApC;;AAEA,iBAAK,oBAAL,CAA0B,IAA1B,EAAgC,EAAhC;AACH,SA/B4D;;;AAkC7D,0BAAmB,4BAAW;AAC1B,mBAAO,KAAK,cAAL,CAAoB,IAApB,GAA2B,GAA3B,CAA+B,UAAS,CAAT,EAAW;AAAC,uBAAO,EAAE,EAAT;AAAa,aAAxD,CAAP;AACH,SApC4D;;;AAuC7D,8BAAuB,gCAAW;AAC9B,mBAAO,KAAK,cAAL,CAAoB,IAApB,GACC,GADD,CACK,UAAS,CAAT,EAAW;AAAE,uBAAO,CAAC,CAAD,EAAI,MAAJ,CAAW,MAAM,YAAN,CAAmB,CAAnB,CAAX,CAAP;AAA0C,aAD5D,EAC6D,IAD7D,EAEC,MAFD,CAEQ,UAAS,CAAT,EAAW,CAAX,EAAa;AAAC,uBAAO,EAAE,MAAF,CAAS,CAAT,CAAP;AAAoB,aAF1C,EAE2C,EAF3C,E;AAGC,eAHD,CAGK,UAAS,CAAT,EAAW;AAAC,uBAAO,EAAE,EAAT;AAAa,aAH9B,EAIC,MAJD,CAIQ,UAAS,CAAT,EAAW,CAAX,EAAa;AAAC,uBAAO,EAAE,OAAF,CAAU,CAAV,IAAe,CAAC,CAAhB,GAAoB,CAApB,GAAwB,EAAE,MAAF,CAAS,CAAT,CAA/B;AAA4C,aAJlE,EAImE,EAJnE,CAAP,C;AAKH,SA7C4D;;;AAiD7D,cAAO,cAAS,SAAT,EAAoB;AACvB,mBAAO,KAAK,oBAAL,GAA4B,OAA5B,CAAoC,SAApC,IAAiD,CAAC,CAAzD;AACH,SAnD4D;;;AAsD7D,iBAAU,iBAAS,SAAT,EAAoB;AAC1B,mBAAO,KAAK,eAAZ;AACH,SAxD4D;;;AA2D7D,yBAAkB,yBAAS,CAAT,EAAY;AAC1B,iBAAK,IAAL,CAAU,gBAAV;AACA,gBAAI,CAAJ,EAAO,KAAK,mBAAL,CAAyB,IAAzB,CAA8B,CAA9B;AACP,gBAAI,YAAY,IAAhB;AACA,mBAAO,SAAP,EAAkB;AACd,oBAAI,eAAe,KAAK,mBAAL,CAAyB,KAAzB,MAAoC,IAAvD;AACA,oBAAI,sBAAuB,KAAK,kBAAL,CAAwB,YAAxB,EAAsC,IAAtC,CAA3B;AACA,oBAAG,oBAAoB,OAApB,EAAH,EAAiC;AAC/B,0CAAsB,KAAK,kBAAL,CAAwB,YAAxB,EAAsC,KAAtC,CAAtB;AACD;;AAED,qBAAK,IAAL,CAAU,kBAAV,EAA8B,YAA9B;AACA,qBAAK,iBAAL,CAAuB,YAAvB,EAAqC,mBAArC;AACA,qBAAK,IAAL,CAAU,gBAAV,EAA4B,YAA5B;AACA,4BAAY,CAAC,oBAAoB,OAApB,EAAb;AACH;AACD,iBAAK,eAAL,GAAuB,KAAK,cAAL,CAAoB,IAApB,GAA2B,KAA3B,CAAiC,UAAS,CAAT,EAAW;AAAE,uBAAO,EAAE,QAAF,KAAe,YAAY,KAAlC;AAA0C,aAAxF,CAAvB;AACA,iBAAK,IAAL,CAAU,cAAV;AACH,SA7E4D;;AA+E7D,8BAAuB,8BAAS,KAAT,EAAgB,EAAhB,EAAoB;AACvC,gBAAI,KAAJ,EAAW;AACP,qBAAK,mBAAL,CAAyB,IAAzB,CAA8B,KAA9B;AACH;;AAED,gBAAI,OAAO,IAAX;AACA,qBAAS,SAAT,CAAmB,WAAnB,EAAgC;AAC5B,oBAAI,mBAAJ;AACA,oBAAI;AACA,yBAAK,IAAL,CAAU,WAAV;AACA,wBAAI,eAAe,KAAK,mBAAL,CAAyB,KAAzB,MAAoC,IAAvD;AACA,wBAAI,sBAAuB,KAAK,kBAAL,CAAwB,YAAxB,EAAsC,IAAtC,CAA3B;AACA,wBAAG,oBAAoB,OAApB,EAAH,EAAiC;AAC/B,8CAAsB,KAAK,kBAAL,CAAwB,YAAxB,EAAsC,KAAtC,CAAtB;AACD;;AAED,yBAAK,IAAL,CAAU,kBAAV,EAA8B,YAA9B;AACA,yBAAK,iBAAL,CAAuB,YAAvB,EAAqC,mBAArC;AACA,yBAAK,IAAL,CAAU,gBAAV,EAA4B,YAA5B;AACH,iBAXD,CAWE,OAAM,GAAN,EAAW;AACT,uBAAG,GAAH;AACA;AACH;;AAED,oBAAI,CAAC,oBAAoB,OAApB,EAAL,EAAoC;;;;AAIhC,yBAAK,IAAL,CAAU,kBAAV;AACA,iCAAa,SAAb,EAAwB,iBAAxB;AACH,iBAND,MAMO;AACH,yBAAK,eAAL,GACI,KAAK,cAAL,CAAoB,IAApB,GAA2B,KAA3B,CAAiC,UAAS,CAAT,EAAY;AACzC,+BAAO,EAAE,QAAF,KAAe,YAAY,KAAlC;AACH,qBAFD,CADJ;AAIA,yBAAK,IAAL,CAAU,cAAV;AACA,uBAAG,SAAH,EAAc,KAAK,gBAAL,EAAd;AACH;AACJ;;AAED,sBAAU,gBAAV;AACH,SAxH4D;;;AA2H7D,2BAAoB,2BAAS,YAAT,EAAuB,mBAAvB,EAA4C;;AAE5D,iBAAK,IAAL,CAAU,yCAAV,EAAqD,KAAK,SAAL,CAAe,YAAf,CAArD;;AAEA,iBAAK,IAAL,CAAU,sBAAV,EAAkC,mBAAlC;;AAEA,gBAAI,CAAC,oBAAoB,OAApB,EAAL,EAAoC;;AAEhC,qBAAK,IAAL,CAAU,oBAAV,EAAgC,mBAAhC;;;;AAIA,oBAAI,iCAAiC,IAAI,KAAK,IAAL,CAAU,GAAd,CAAkB,oBAAoB,IAApB,GAA2B,MAA3B,CAAkC,qBAAlC,CAAlB,CAArC;;AAEA,oBAAI,cAAc,KAAK,gBAAL,CAAsB,8BAAtB,CAAlB;AAAA,oBACI,oBAAoB,YAAY,CAAZ,CADxB;AAAA,oBAEI,eAAe,YAAY,CAAZ,CAFnB;;AAIA,oBAAI,eAAe,KAAK,iBAAL,CAAuB,8BAAvB,CAAnB;AAAA,oBACI,qBAAqB,aAAa,CAAb,CADzB;AAAA,oBAEI,gBAAgB,aAAa,CAAb,CAFpB;;AAIA,qBAAK,IAAL,CAAU,oBAAV,EAAgC,iBAAhC;AACA,qBAAK,IAAL,CAAU,qBAAV,EAAiC,kBAAjC;AACA,qBAAK,IAAL,CAAU,eAAV,EAA2B,YAA3B;AACA,qBAAK,IAAL,CAAU,gBAAV,EAA4B,aAA5B;;AAEA,oBAAI,0BAA0B,IAAI,KAAK,IAAL,CAAU,GAAd,EAA9B;;;AAGA,qBAAK,IAAL,CAAU,8BAAV;;AAEA,qBAAK,IAAI,IAAI,CAAR,EAAW,MAAM,aAAa,MAAnC,EAA2C,IAAI,GAA/C,EAAoD,GAApD,EAAyD;AACrD,wBAAI,cAAc,aAAa,CAAb,CAAlB;;AAEA,yBAAK,IAAL,CAAU,UAAV,EAAsB,YAAY,EAAlC;;;AAGA,yBAAK,IAAL,CAAU,QAAV,EAAmB,YAAY,EAA/B;;AAEA,wBAAG,YAAY,MAAZ,KAAuB,SAA1B,EAAqC;AACjC,6BAAK,IAAI,UAAU,CAAd,EAAiB,UAAU,YAAY,MAAZ,CAAmB,MAAnD,EAA2D,UAAU,OAArE,EAA8E,SAA9E,EAAyF;AACrF,iCAAK,eAAL,CAAqB,YAArB,EAAmC,YAAY,MAAZ,CAAmB,OAAnB,CAAnC;AACH;AACJ;;AAED,wBAAI,CAAJ;AACA,wBAAI,YAAY,UAAhB,EAA4B;AACxB,4BAAI,YAAY,UAAZ,CAAuB,MAA3B,EAAmC;AAC/B,gCAAI,WAAS,EAAT,EAAa;AACb,uCAAO,GAAG,QAAH,KAAgB,YAAY,KAA5B,IAAqC,YAAY,WAAZ,CAAwB,OAAxB,CAAgC,EAAhC,IAAsC,CAAC,CAAnF;AACH,6BAFD;AAGH,yBAJD,MAIO;AACH,gCAAI,WAAS,EAAT,EAAa;AACb,uCAAO,GAAG,MAAH,KAAc,WAArB;AACH,6BAFD;AAGH;;AAED,6BAAK,aAAL,CAAmB,YAAY,UAAZ,CAAuB,EAA1C,IAAgD,aAAa,MAAb,CAAoB,CAApB,CAAhD;AACH;AACJ;;;;AAID,oBAAI,oBAAoB,oBAAoB,IAApB,GAA2B,IAA3B,CAAgC,oBAAhC,CAAxB;;AAEA,qBAAK,IAAL,CAAU,gCAAV;;AAGA,qBAAK,IAAI,SAAS,CAAb,EAAgB,MAAM,kBAAkB,MAA7C,EAAqD,SAAS,GAA9D,EAAmE,QAAnE,EAA6E;AACzE,wBAAI,aAAa,kBAAkB,MAAlB,CAAjB;;AAEA,wBAAI,YAAY,WAAW,OAAX,IAAsB,WAAW,OAAX,CAAmB,GAAnB,CAAuB,UAAS,MAAT,EAAgB;AAAC,+BAAO,OAAO,EAAd;AAAkB,qBAA1D,CAAtC;;AAEA,yBAAK,IAAL,CAAU,cAAV,EAAyB,WAAW,MAAX,CAAkB,EAA3C,EAA8C,SAA9C,EAAyD,MAAzD;;AAEA,wBAAG,WAAW,YAAX,KAA4B,SAA/B,EAA0C;AACtC,6BAAK,IAAI,QAAQ,CAAZ,EAAe,QAAQ,WAAW,YAAX,CAAwB,MAApD,EAA4D,QAAQ,KAApE,EAA2E,OAA3E,EAAoF;AAChF,iCAAK,eAAL,CAAqB,YAArB,EAAmC,WAAW,YAAX,CAAwB,KAAxB,CAAnC;AACH;AACJ;AACJ;;AAED,qBAAK,IAAL,CAAU,+BAAV;;AAEA,qBAAK,IAAI,WAAW,CAAf,EAAkB,WAAW,cAAc,MAAhD,EAAwD,WAAW,QAAnE,EAA6E,UAA7E,EAAyF;AACrF,wBAAI,eAAe,cAAc,QAAd,CAAnB;;AAEA,yBAAK,IAAL,CAAU,UAAV,EAAsB,aAAa,EAAnC;;AAEA,yBAAK,IAAL,CAAU,SAAV,EAAoB,aAAa,EAAjC;;AAEA,wBAAG,aAAa,OAAb,KAAyB,SAA5B,EAAuC;AACnC,6BAAK,IAAI,WAAW,CAAf,EAAkB,WAAW,aAAa,OAAb,CAAqB,MAAvD,EAA+D,WAAW,QAA1E,EAAoF,UAApF,EAAgG;AAC5F,iCAAK,eAAL,CAAqB,YAArB,EAAmC,aAAa,OAAb,CAAqB,QAArB,CAAnC;AACH;AACJ;AACJ;;AAED,qBAAK,IAAL,CAAU,yBAAV;AACA,qBAAK,IAAL,CAAU,oBAAV,EAAgC,KAAK,cAArC;;;AAGA,qBAAK,cAAL,CAAoB,UAApB,CAA+B,iBAA/B;AACA,qBAAK,cAAL,CAAoB,KAApB,CAA0B,kBAA1B;;AAGA,qBAAK,IAAL,CAAU,oBAAV,EAAgC,KAAK,cAArC;;;AAGA,oBAAI,CAAC,wBAAwB,OAAxB,EAAL,EAAwC;AACpC,yBAAK,IAAL,CAAU,yCAAV,EAAqD,uBAArD;AACA,yBAAK,mBAAL,CAAyB,IAAzB,CAA8B,uBAA9B;AACH;AAEJ;;;AAGD,mBAAO,mBAAP;AACH,SAlP4D;;;AAqP7D,yBAAkB,yBAAS,YAAT,EAAuB,SAAvB,EAAkC;AAChD,gBAAI;AACF,uBAAO,UAAU,IAAV,CAAe,KAAK,iBAApB,EAAuC,YAAvC,CAAP,C;AACD,aAFD,CAEE,OAAO,CAAP,EAAS;AACT,oBAAI,MAAM;AACR,6BAAS,UAAU,OADX;AAER,0BAAM,UAAU,IAFR;AAGR,4BAAQ,UAAU,MAHV;AAIR,4BAAQ,EAAE;AAJF,iBAAV;AAMA,qBAAK,mBAAL,CAAyB,IAAzB,CAA8B,EAAC,QAAO,iBAAR,EAA0B,MAAO,GAAjC,EAA9B;AACA,qBAAK,IAAL,CAAU,SAAV,EAAqB,GAArB;AACD;AACJ,SAlQ4D;;;AAqQ7D,0BAAmB,0BAAS,WAAT,EAAsB;AACrC,gBAAI,eAAe,IAAI,KAAK,IAAL,CAAU,GAAd,EAAnB;AACA,gBAAI,oBAAoB,IAAI,KAAK,IAAL,CAAU,GAAd,EAAxB;;;;;;AAMA,gBAAI,iBAAiB,YAAY,IAAZ,EAArB;AACA,iBAAK,IAAI,QAAQ,CAAZ,EAAe,QAAQ,eAAe,MAA3C,EAAmD,QAAQ,KAA3D,EAAkE,OAAlE,EAA2E;AACvE,oBAAI,aAAa,eAAe,KAAf,CAAjB;AACA,oBAAI,QAAQ,WAAW,KAAvB;AAAA,oBACI,OAAO,MAAM,WADjB;;;;;AAMA,oBAAI,aAAa,KAAK,cAAL,CAAoB,IAApB,EAAjB;AACA,qBAAK,IAAI,SAAS,CAAb,EAAgB,SAAS,WAAW,MAAzC,EAAiD,SAAS,MAA1D,EAAkE,QAAlE,EAA4E;AACxE,wBAAI,QAAQ,WAAW,MAAX,CAAZ;AACA,wBAAG,KAAK,OAAL,CAAa,KAAb,IAAsB,CAAC,CAA1B,EAA4B;AACxB,0CAAkB,GAAlB,CAAsB,KAAtB;AACA,qCAAa,GAAb,CAAiB,KAAjB;AACA,4BAAI,YAAY,MAAM,YAAN,CAAmB,KAAnB,EAAyB,KAAzB,CAAhB;AACA,6BAAK,IAAI,SAAS,CAAb,EAAgB,SAAS,UAAU,MAAxC,EAAgD,SAAS,MAAzD,EAAiE,QAAjE,EAA2E;AACvE,yCAAa,GAAb,CAAiB,UAAU,MAAV,CAAjB;AACH;AACJ;AACJ;AACJ;;AAED,gBAAI,qBAAqB,aAAa,IAAb,GAAoB,IAApB,CAAyB,qCAAzB,CAAzB;AACA,mBAAO,CAAC,iBAAD,EAAoB,kBAApB,CAAP;AACH,SAtS4D;;;AAyS7D,2BAAoB,2BAAS,WAAT,EAAsB;;AAEtC,gBAAI,IAAI;AACJ,+BAAgB,IAAI,KAAK,IAAL,CAAU,GAAd,EADZ;AAEJ,oCAAqB,IAAI,KAAK,IAAL,CAAU,GAAd,EAFjB;AAGJ,iCAAmB,IAAI,KAAK,IAAL,CAAU,GAAd,EAHf;AAIJ,iCAAkB;AAJd,aAAR;;;AAQA,gBAAI,iBAAiB,YAAY,IAAZ,EAArB;AACA,iBAAK,IAAI,QAAQ,CAAZ,EAAe,QAAQ,eAAe,MAA3C,EAAmD,QAAQ,KAA3D,EAAkE,OAAlE,EAA2E;AACvE,oBAAI,aAAa,eAAe,KAAf,CAAjB;AACA,qBAAK,IAAI,YAAY,CAAhB,EAAmB,YAAY,WAAW,OAAX,CAAmB,MAAvD,EAA+D,YAAY,SAA3E,EAAsF,WAAtF,EAAmG;AAC/F,yBAAK,qBAAL,CAA2B,WAAW,OAAX,CAAmB,SAAnB,CAA3B,EAAyD,WAAW,KAApE,EAA0E,CAA1E;AACH;AACJ;;;AAGD,gBAAI,CAAJ;;AAEA,mBAAM,IAAI,EAAE,eAAF,CAAkB,GAAlB,EAAV,EAAkC;;AAE9B,qBAAK,uBAAL,CAA6B,CAA7B,EAA+B,CAA/B;AACH;;;AAGD,gBAAI,sBAAsB,EAAE,aAAF,CAAgB,IAAhB,GAAuB,IAAvB,CACxB,UAAS,EAAT,EAAa,EAAb,EAAgB;AACd,uBAAO,sCAAsC,EAAtC,EAA0C,EAA1C,IAAgD,CAAC,CAAxD;AACD,aAHuB,CAA1B;;AAKA,mBAAO,CAAC,EAAE,kBAAH,EAAuB,mBAAvB,CAAP;AACH,SA1U4D;;;AA6U7D,+BAAwB,+BAAS,MAAT,EAAgB,KAAhB,EAAsB,CAAtB,EAAwB;;;AAG5C,iBAAK,uBAAL,CAA6B,MAA7B,EAAoC,CAApC;;;AAGA,gBAAI,YAAY,MAAM,YAAN,CAAmB,MAAnB,EAA0B,KAA1B,CAAhB;AACA,iBAAK,IAAI,SAAS,CAAb,EAAgB,SAAS,UAAU,MAAxC,EAAgD,SAAS,MAAzD,EAAiE,QAAjE,EAA2E;AACvE,oBAAI,IAAI,UAAU,MAAV,CAAR;AACA,oBAAI,EAAE,QAAF,KAAe,YAAY,SAA/B,EAA0C;;;AAGtC,sBAAE,aAAF,CAAgB,GAAhB,CAAoB,CAApB;;AAEA,sBAAE,eAAF,CAAkB,GAAlB,CAAsB,CAAtB;AACH,iBAND,MAMK;;AAED,yBAAK,uBAAL,CAA6B,CAA7B,EAA+B,CAA/B;AACH;AACJ;AACJ,SAjW4D;;;AAoW7D,iCAA0B,iCAAS,CAAT,EAAW,CAAX,EAAa;;AAEnC,gBAAG,EAAE,eAAF,CAAkB,QAAlB,CAA2B,CAA3B,CAAH,EAAkC;;AAElC,gBAAI,EAAE,QAAF,KAAe,YAAY,OAA/B,EAAwC;AACpC,oBAAI,EAAE,EAAF,IAAQ,KAAK,aAAjB,EAAgC;AAC5B,yBAAK,aAAL,CAAmB,EAAE,EAArB,EAAyB,OAAzB,CAAiC,UAAS,gBAAT,EAA0B;AACvD,6BAAK,qBAAL,CAA2B,gBAA3B,EAA4C,EAAE,MAA9C,EAAqD,CAArD;AACH,qBAFD,EAEE,IAFF;AAGH,iBAJD,MAIO;AACH,sBAAE,aAAF,CAAgB,GAAhB,CAAoB,CAApB;AACA,sBAAE,kBAAF,CAAqB,GAArB,CAAyB,CAAzB;AACH;AACJ,aATD,MASO;AACH,kBAAE,aAAF,CAAgB,GAAhB,CAAoB,CAApB;;AAEA,oBAAI,EAAE,QAAF,KAAe,YAAY,QAA/B,EAAyC;AACrC,sBAAE,eAAF,CAAkB,IAAlB,CAAuB,KAAvB,CAA6B,EAAE,eAA/B,EACI,EAAE,MAAF,CAAS,MAAT,CAAgB,UAAS,CAAT,EAAW;AAAC,+BAAO,EAAE,QAAF,KAAe,YAAY,OAAlC;AAA2C,qBAAvE,CADJ;AAEH,iBAHD,MAGO,IAAI,EAAE,QAAF,KAAe,YAAY,SAA/B,EAA0C;AAC7C,sBAAE,eAAF,CAAkB,IAAlB,CAAuB,EAAE,UAAzB;AACH,iBAFM,MAEA,IAAI,EAAE,QAAF,KAAe,YAAY,OAA3B,IAAsC,EAAE,QAAF,KAAe,YAAY,KAAjE,IAA0E,EAAE,QAAF,KAAe,YAAY,KAAzG,EAAgH;AACnH,sBAAE,kBAAF,CAAqB,GAArB,CAAyB,CAAzB;AACH;AACJ;;AAED,cAAE,eAAF,CAAkB,GAAlB,CAAsB,CAAtB;AACH,SA/X4D;;;AAkY7D,4BAAqB,4BAAS,YAAT,EAAuB,0BAAvB,EAAmD;AACpE,gBAAI,KAAK,IAAL,CAAU,yBAAd,EAAyC;AACrC,oBAAI,SAAS,KAAK,cAAL,CAAoB,IAApB,EAAb;AACH,aAFD,MAEO;AACH,oBAAI,mBAAmB,IAAI,KAAK,IAAL,CAAU,GAAd,EAAvB;;;;AAIA,oBAAI,aAAa,KAAK,cAAL,CAAoB,IAApB,EAAjB;AACA,qBAAK,IAAI,MAAM,CAAV,EAAa,MAAM,WAAW,MAAnC,EAA2C,MAAM,GAAjD,EAAsD,KAAtD,EAA6D;AACzD,wBAAI,aAAa,WAAW,GAAX,CAAjB;AACA,qCAAiB,GAAjB,CAAqB,UAArB;AACA,wBAAI,YAAY,MAAM,YAAN,CAAmB,UAAnB,CAAhB;AACA,yBAAK,IAAI,SAAS,CAAb,EAAgB,SAAS,UAAU,MAAxC,EAAgD,SAAS,MAAzD,EAAiE,QAAjE,EAA2E;AACvE,yCAAiB,GAAjB,CAAqB,UAAU,MAAV,CAArB;AACH;AACJ;;AAED,yBAAS,iBAAiB,IAAjB,EAAT;AACH;;AAED,gBAAI,qBAAqB,KAAK,IAAL,CAAU,kBAAnC;AACA,gBAAI,qBAAqB,IAAI,KAAK,IAAL,CAAU,GAAd,EAAzB;;AAEA,gBAAI,IAAI,KAAK,eAAL,CAAqB,IAArB,CAA0B,IAA1B,EAA+B,YAA/B,CAAR;;AAEA,iBAAK,IAAI,WAAW,CAAf,EAAkB,WAAW,OAAO,MAAzC,EAAiD,WAAW,QAA5D,EAAsE,UAAtE,EAAkF;AAC9E,oBAAI,cAAc,mBAAmB,OAAO,QAAP,CAAnB,EAAqC,YAArC,EAAmD,CAAnD,EAAsD,0BAAtD,CAAlB;AACA,qBAAK,IAAI,QAAQ,CAAZ,EAAe,MAAM,YAAY,MAAtC,EAA8C,QAAQ,GAAtD,EAA2D,OAA3D,EAAoE;AAChE,uCAAmB,GAAnB,CAAuB,YAAY,KAAZ,CAAvB;AACH;AACJ;;AAED,gBAAI,6BAA6B,KAAK,iCAAL,CAAuC,kBAAvC,CAAjC;;AAEA,iBAAK,IAAL,CAAU,4BAAV,EAAwC,0BAAxC;;AAEA,mBAAO,0BAAP;AACH,SAxa4D;;;AA2a7D,2CAAoC,2CAAS,kBAAT,EAA6B;AAC7D,gBAAI,6BAA6B,IAAI,KAAK,IAAL,CAAU,GAAd,EAAjC;;AAEA,gBAAI,QAAQ,KAAK,2BAAL,CAAiC,kBAAjC,CAAZ;AAAA,gBACI,wBAAwB,MAAM,CAAN,CAD5B;AAAA,gBAEI,+BAA+B,MAAM,CAAN,CAFnC;;AAIA,uCAA2B,KAA3B,CAAiC,qBAAjC;;AAEA,iBAAK,IAAL,CAAU,oBAAV,EAAgC,kBAAhC;AACA,iBAAK,IAAL,CAAU,uBAAV,EAAmC,qBAAnC;AACA,iBAAK,IAAL,CAAU,8BAAV,EAA0C,4BAA1C;AACA,iBAAK,IAAL,CAAU,4BAAV,EAAwC,0BAAxC;;AAEA,mBAAO,CAAC,6BAA6B,OAA7B,EAAR,EAAgD;AAC5C,qCAAqB,IAAI,KAAK,IAAL,CAAU,GAAd,CACb,6BAA6B,IAA7B,GAAoC,GAApC,CAAwC,UAAS,CAAT,EAAW;AAAC,2BAAO,KAAK,IAAL,CAAU,oBAAV,CAA+B,CAA/B,CAAP;AAA0C,iBAA9F,EAA+F,IAA/F,CADa,CAArB;;AAGA,wBAAQ,KAAK,2BAAL,CAAiC,kBAAjC,CAAR;AACA,wCAAwB,MAAM,CAAN,CAAxB;AACA,+CAA+B,MAAM,CAAN,CAA/B;;AAEA,2CAA2B,KAA3B,CAAiC,qBAAjC;;AAEA,qBAAK,IAAL,CAAU,oBAAV,EAAgC,kBAAhC;AACA,qBAAK,IAAL,CAAU,uBAAV,EAAmC,qBAAnC;AACA,qBAAK,IAAL,CAAU,8BAAV,EAA0C,4BAA1C;AACA,qBAAK,IAAL,CAAU,4BAAV,EAAwC,0BAAxC;AAEH;AACD,mBAAO,0BAAP;AACH,SA1c4D;;;AA6c7D,qCAA8B,qCAAS,WAAT,EAAsB;AAChD,gBAAI,6BAA6B,IAAI,KAAK,IAAL,CAAU,GAAd,EAAjC;AACA,gBAAI,+BAA+B,IAAI,KAAK,IAAL,CAAU,GAAd,EAAnC;AACA,gBAAI,iBAAiB,YAAY,IAAZ,EAArB;;AAEA,iBAAK,IAAL,CAAU,aAAV,EAAyB,WAAzB;;AAEA,iBAAI,IAAI,IAAI,CAAZ,EAAe,IAAI,eAAe,MAAlC,EAA0C,GAA1C,EAA8C;AAC1C,qBAAI,IAAI,IAAI,IAAE,CAAd,EAAiB,IAAI,eAAe,MAApC,EAA4C,GAA5C,EAAgD;AAC5C,wBAAI,KAAK,eAAe,CAAf,CAAT;AACA,wBAAI,KAAK,eAAe,CAAf,CAAT;AACA,wBAAI,KAAK,UAAL,CAAgB,EAAhB,EAAoB,EAApB,CAAJ,EAA6B;AACzB,mDAA2B,GAA3B,CAA+B,EAA/B;AACA,mDAA2B,GAA3B,CAA+B,EAA/B;AACA,qDAA6B,GAA7B,CAAiC,CAAC,EAAD,EAAK,EAAL,CAAjC;AACH;AACJ;AACJ;;AAED,gBAAI,wBAAwB,YAAY,UAAZ,CAAuB,0BAAvB,CAA5B;AACA,mBAAO,CAAC,qBAAD,EAAwB,4BAAxB,CAAP;AACH,SAle4D;;AAoe7D,cAAO,gBAAU;AACf,gBAAG,UAAH,EAAc;AACZ,oBAAI,OAAO,MAAM,IAAN,CAAW,SAAX,CAAX;AACA,qBAAK,IAAL,CAAU,OAAV,CAAkB,GAAlB,CACK,KAAK,CAAL,CADL,UAEI,KAAK,KAAL,CAAW,CAAX,EAAc,GAAd,CAAkB,UAAS,GAAT,EAAa;AAC7B,2BAAO,QAAQ,IAAR,GAAe,MAAf,GACH,QAAQ,SAAR,GAAoB,WAApB,GACE,OAAO,GAAP,KAAe,QAAf,GAA0B,GAA1B,GACE,IAAI,SAAJ,KAAkB,OAAO,SAAzB,GAAqC,KAAK,SAAL,CAAe,GAAf,CAArC,GAA2D,IAAI,QAAJ,EAHnE;AAKD,iBAND,EAMG,IANH,CAMQ,IANR,CAFJ;AAWD;AACF,SAnf4D;;;AAsf7D,oBAAa,oBAAS,EAAT,EAAa,EAAb,EAAiB;AAC1B,mBAAO,CAAC,KAAK,kBAAL,CAAwB,EAAxB,EAA4B,EAA5B,CAAR;AACH,SAxf4D;;;AA2f7D,4BAAqB,4BAAS,EAAT,EAAa,EAAb,EAAiB;;AAElC,iBAAK,IAAL,CAAU,mBAAV,EAA+B,GAAG,KAAlC,EAAyC,GAAG,KAA5C;;AAEA,gBAAI,eAAe,MAAM,cAAN,CAAqB,GAAG,KAAxB,EAA+B,GAAG,KAAlC,CAAnB;;AAEA,iBAAK,IAAL,CAAU,mCAAV,EAA+C,YAA/C;;AAEA,mBAAO,YAAP;AACH,SApgB4D;;;;;;;;;;;;;;;;;;;;;;;;AA6hB7D,0BAAmB,0BAAS,QAAT,EAAkB;AACjC,4BAAgB,MAAhB,CAAuB,OAAvB,CAA+B,UAAS,KAAT,EAAe;AAC5C,oBAAG,SAAS,KAAT,CAAH,EAAoB,KAAK,EAAL,CAAQ,KAAR,EAAc,SAAS,KAAT,CAAd;AACrB,aAFD;AAGH,SAjiB4D;;;AAoiB7D,4BAAqB,4BAAS,QAAT,EAAkB;AACnC,4BAAgB,MAAhB,CAAuB,OAAvB,CAA+B,UAAS,KAAT,EAAe;AAC5C,oBAAG,SAAS,KAAT,CAAH,EAAoB,KAAK,GAAL,CAAS,KAAT,EAAe,SAAS,KAAT,CAAf;AACrB,aAFD;AAGH,SAxiB4D;;;AA2iB7D,gCAAyB,kCAAU;AAC/B,gBAAI,SAAS,EAAb;AACA,qBAAS,SAAT,CAAmB,KAAnB,EAAyB;;AAErB,oBAAG,MAAM,WAAT,EAAqB;AACjB,yBAAK,IAAI,QAAQ,CAAZ,EAAe,QAAQ,MAAM,WAAN,CAAkB,MAA9C,EAAsD,QAAQ,KAA9D,EAAqE,OAArE,EAA8E;AAC1E,+BAAO,MAAM,WAAN,CAAkB,KAAlB,EAAyB,KAAhC,IAAyC,IAAzC;AACH;AACJ;;AAED,oBAAG,MAAM,MAAT,EAAiB;AACb,yBAAK,IAAI,WAAW,CAAf,EAAkB,WAAW,MAAM,MAAN,CAAa,MAA/C,EAAuD,WAAW,QAAlE,EAA4E,UAA5E,EAAwF;AACpF,kCAAU,MAAM,MAAN,CAAa,QAAb,CAAV;AACH;AACJ;AACJ;;AAED,sBAAU,KAAK,MAAf;;AAEA,mBAAO,OAAO,IAAP,CAAY,MAAZ,CAAP;AACH,SA/jB4D;;;;;;;;;;;;;;;;;AAklB7D,qBAAc,uBAAU;AACtB,gBAAG,KAAK,WAAR,EAAqB,MAAM,IAAI,KAAJ,CAAU,wEAAV,CAAN;;AAGrB,mBAAO,CACL,KAAK,gBAAL,EADK,EAEL,KAAK,iBAAL,EAFK,EAGL,KAAK,eAHA,EAIL,KAAK,MAAL,CAAY,mBAAZ,EAJK,CAAP;AAMD,SA5lB4D;;AA8lB7D,2BAAoB,6BAAU;AAC5B,gBAAI,IAAI,EAAR;AACA,mBAAO,IAAP,CAAY,KAAK,aAAjB,EAAgC,OAAhC,CAAwC,UAAS,GAAT,EAAa;AACnD,kBAAE,GAAF,IAAS,KAAK,aAAL,CAAmB,GAAnB,EAAwB,GAAxB,CAA4B,UAAS,KAAT,EAAe;AAAC,2BAAO,MAAM,EAAb;AAAgB,iBAA5D,CAAT;AACD,aAFD,EAEE,IAFF;AAGA,mBAAO,CAAP;AACD;AApmB4D,KAArC,CAA5B;;;;;;AA2mBA,aAAS,UAAT,CAAoB,KAApB,EAA2B,IAA3B,EAAiC;AAC7B,eAAO,QAAQ,EAAf;;AAEA,aAAK,YAAL,GAAoB,EAApB;;;;AAIA,aAAK,IAAI,aAAT,IAA0B,gBAA1B,EAA4C;AACxC,iBAAK,YAAL,CAAkB,aAAlB,IAAmC,iBAAiB,aAAjB,CAAnC;AACH;;AAED,aAAK,2BAAL,GAAmC,KAAK,2BAAL,IAAoC,2BAAvE;;AAEA,aAAK,WAAL,GAAmB,KAAnB;;AAEA,wBAAgB,IAAhB,CAAqB,IAArB,EAA0B,KAA1B,EAAgC,IAAhC,E;AACH;;AAED,aAAS,KAAT,CAAe,CAAf,EAAiB;AACb,iBAAS,CAAT,GAAY,CAAE;AACd,UAAE,SAAF,GAAc,CAAd;AACA,eAAO,IAAI,CAAJ,EAAP;AACH;;;;;AAKD,aAAS,GAAT,GAAe,CAAE;;;;AAIjB,eAAW,SAAX,GAAuB,MAAM,gBAAgB,SAAtB,CAAvB;;;AAGA,eAAW,SAAX,CAAqB,GAArB,GAA2B,UAAS,YAAT,EAAsB,YAAtB,EAAoC;;AAE3D,YAAI,YAAJ;AACA,uBAAc,YAAd,yCAAc,YAAd;AACI,iBAAK,QAAL;AACI,+BAAe,EAAC,MAAO,YAAR,EAAsB,MAAO,YAA7B,EAAf;AACA;AACJ,iBAAK,QAAL;AACI,oBAAG,OAAO,aAAa,IAApB,KAA6B,QAAhC,EAAyC;AACrC,mCAAe,YAAf;AACH,iBAFD,MAEK;AACD,0BAAM,IAAI,KAAJ,CAAU,wDAAV,CAAN;AACH;AACD;AACJ;AACI,sBAAM,IAAI,KAAJ,CAAU,mDAAV,CAAN;AAZR;;AAeA,YAAG,KAAK,WAAR,EAAqB,MAAM,IAAI,KAAJ,CAAU,mCAAV,CAAN;;;AAGrB,aAAK,WAAL,GAAmB,IAAnB;;AAEA,aAAK,eAAL,CAAqB,YAArB;;AAEA,aAAK,WAAL,GAAmB,KAAnB;AACA,eAAO,KAAK,gBAAL,EAAP;AACH,KA3BD;;;;;;;;;;AAqCA,eAAW,SAAX,CAAqB,QAArB,GAAgC,UAAS,YAAT,EAAuB,EAAvB,EAA2B;AACvD,YAAI,QAAO,YAAP,yCAAO,YAAP,OAAwB,QAAxB,IAAoC,CAAC,YAArC,IAAqD,OAAO,aAAa,IAApB,KAA6B,QAAtF,EAAgG;AAC5F,kBAAM,IAAI,KAAJ,CAAU,mDAAV,CAAN;AACH;;AAED,YAAG,KAAK,WAAR,EAAqB;AACjB,kBAAM,IAAI,KAAJ,CAAU,mCAAV,CAAN;AACH;;AAED,YAAI,OAAO,EAAP,KAAc,UAAlB,EAA8B;AAC1B,iBAAK,GAAL;AACH;;AAED,aAAK,WAAL,GAAmB,IAAnB;;AAEA,YAAI,OAAO,IAAX;AACA,aAAK,oBAAL,CAA0B,YAA1B,EAAwC,UAAS,GAAT,EAAc,MAAd,EAAsB;AAC1D,iBAAK,WAAL,GAAmB,KAAnB;AACA,eAAG,GAAH,EAAQ,MAAR;AACH,SAHD;AAIH,KApBD;;AAsBA,aAAS,2BAAT,CAAqC,WAArC,EAAkD;AAC9C,aAAK,YAAL,GAAoB,WAApB;AACA,aAAK,WAAL,GAAmB,EAAnB;AACH;;;;;AAKD,QAAI,mBAAmB,6MAAvB;;;AAGA,gCAA4B,SAA5B,GAAwC;AACpC,eAAQ,eAAS,KAAT,EAAe;AACnB,iBAAK,YAAL,CAAkB,mBAAlB,CAAsC,IAAtC,CAA2C,KAA3C;AACH,SAHmC;AAIpC,cAAO,cAAS,KAAT,EAAgB,OAAhB,EAAwB;;AAE3B,qBAAS,YAAT,CAAsB,KAAtB,EAA6B,OAA7B,EAAsC,UAAtC,EAAiD;AAC/C,oBAAG,MAAM,MAAT,EAAgB;AACd,wBAAI,mBAAmB,iBAAiB,IAAjB,CAAsB,MAAM,MAA5B,CAAvB;AACA,wBAAG,CAAC,gBAAJ,EAAqB;AACnB,+BAAO,KAAK,KAAL,CAAW,EAAE,MAAO,iBAAT,EAA4B,MAAM,yBAAlC,EAA6D,QAAQ,QAAQ,MAA7E,EAAX,CAAP;AACD;AACF;;AAED,oBAAI,sBAAsB,OAAO,IAAP,CAAY,gBAAZ,EAA8B,GAA9B,CAAkC,UAAS,CAAT,EAAW;AAAC,2BAAO,iBAAiB,CAAjB,EAAoB,QAA3B;AAAoC,iBAAlF,CAA1B;AACA,oBAAG,oBAAoB,OAApB,CAA4B,MAAM,IAAlC,MAA4C,CAAC,CAAhD,EAAmD;AAC/C,2BAAO,KAAK,KAAL,CAAW,EAAE,MAAO,iBAAT,EAA4B,MAAM,kCAAlC,EAAsE,QAAQ,QAAQ,MAAtF,EAAX,CAAP;AACH;;AAED,2BAAW,IAAX,CAAgB,IAAhB,EAAsB,KAAtB,EAA6B,OAA7B;AACD;;AAED,qBAAS,iBAAT,CAA4B,KAA5B,EAAmC,OAAnC,EAA4C;;AAE1C,oBAAI,OAAO,UAAP,KAAsB,WAA1B,EAAwC,MAAM,IAAI,KAAJ,CAAU,0GAAV,CAAN;;AAExC,oBAAI,YAAY,WAAW,KAAK,YAAL,CAAkB,GAAlB,CAAsB,IAAtB,CAA2B,KAAK,YAAhC,EAA8C,KAA9C,CAAX,EAAiE,QAAQ,KAAR,IAAiB,CAAlF,CAAhB;;AAEA,oBAAI,QAAQ,MAAZ,EAAoB,KAAK,WAAL,CAAiB,QAAQ,MAAzB,IAAmC,SAAnC;AACrB;;AAED,qBAAS,OAAT,GAAkB;AAChB,qBAAK,YAAL,CAAkB,IAAlB,CAAuB,MAAM,IAA7B,EAAkC,MAAM,IAAxC;AACD;;AAED,kBAAM,IAAN,GAAa,MAAM,IAAN,IAAc,iBAAiB,KAAjB,CAAuB,QAAlD;;;AAGA,gBAAI,MAAJ;AACA,gBAAG,MAAM,IAAN,KAAe,0CAAlB,EAA6D;AAC3D,yBAAS,OAAT;AACD,aAFD,MAEM,IAAG,KAAK,YAAL,CAAkB,IAAlB,CAAuB,UAA1B,EAAqC;AACzC,yBAAS,KAAK,YAAL,CAAkB,IAAlB,CAAuB,UAAhC;AACD,aAFK,MAED;AACH,yBAAS,iBAAT;AACD;;AAED,sBAAQ,WAAW,EAAnB;;AAEA,iBAAK,YAAL,CAAkB,IAAlB,CAAuB,eAAvB,EAAwC,MAAM,IAA9C,EAAoD,cAApD,EAAoE,MAAM,IAA1E,EAAgF,aAAhF,EAA+F,QAAQ,KAAvG;;AAEA,yBAAa,IAAb,CAAkB,IAAlB,EAAwB,KAAxB,EAA+B,OAA/B,EAAwC,MAAxC;AACH,SApDmC;AAqDpC,gBAAS,gBAAS,MAAT,EAAgB;AACrB,gBAAG,KAAK,YAAL,CAAkB,IAAlB,CAAuB,YAA1B,EAAwC;AACpC,uBAAO,KAAK,YAAL,CAAkB,IAAlB,CAAuB,YAAvB,CAAoC,KAApC,CAA0C,IAA1C,EAAgD,CAAC,MAAD,CAAhD,CAAP;AACH;;AAED,gBAAI,OAAO,YAAP,KAAwB,WAA5B,EAA0C,MAAM,IAAI,KAAJ,CAAU,4GAAV,CAAN;;AAE1C,gBAAI,UAAU,KAAK,WAAnB,EAAgC;AAC5B,qBAAK,YAAL,CAAkB,IAAlB,CAAuB,aAAvB,EAAsC,MAAtC,EAA8C,mBAA9C,EAAmE,KAAK,WAAL,CAAiB,MAAjB,CAAnE;AACA,6BAAa,KAAK,WAAL,CAAiB,MAAjB,CAAb;AACH;AACJ;AAhEmC,KAAxC;;AAmEA,WAAO,OAAP,GAAiB;;AAEb,yBAAiB,eAFJ;;AAIb,oBAAY,UAJC;;AAMb,kBAAW,QANE;;AAQb,qBAAc,WARD;;AAUb,yBAAkB,eAVL;;AAYb,qCAA8B,2BAZjB;;AAcb,0BAAoB;AAdP,KAAjB","file":"scion.js","sourcesContent":["//   Copyright 2011-2012 Jacob Beard, INFICON, and other SCION contributors\n//\n//   Licensed under the Apache License, Version 2.0 (the \"License\");\n//   you may not use this file except in compliance with the License.\n//   You may obtain a copy of the License at\n//\n//       http://www.apache.org/licenses/LICENSE-2.0\n//\n//   Unless required by applicable law or agreed to in writing, software\n//   distributed under the License is distributed on an \"AS IS\" BASIS,\n//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n//   See the License for the specific language governing permissions and\n//   limitations under the License.\n\nvar extend = Object.assign || \n    function (to, from){\n      Object.keys(from).forEach(function(k){\n        to[k] = from[k]; \n      });\n      return to;\n    };\n\nvar STATE_TYPES = {\n    BASIC: 0,\n    COMPOSITE: 1,\n    PARALLEL: 2,\n    HISTORY: 3,\n    INITIAL: 4,\n    FINAL: 5\n};\n\nvar ioProcessorTypes = {\n    'scxml': {\n        location: 'http://www.w3.org/TR/scxml/#SCXMLEventProcessor'\n    },\n    'basichttp': {\n        location: 'http://www.w3.org/TR/scxml/#BasicHTTPEventProcessor'\n    },\n    'dom': {\n        location: 'http://www.w3.org/TR/scxml/#DOMEventProcessor'\n    },\n    'publish': {\n        location: 'https://github.com/jbeard4/SCION#publish'\n    }\n};\n\nfunction transitionWithTargets(t){\n    return t.targets;\n}\n\nfunction transitionComparator(t1, t2) {\n    return t1.documentOrder - t2.documentOrder;\n}\n\nfunction initializeModel(rootState){\n    var transitions = [], idToStateMap = new Map(), documentOrder = 0;\n\n\n    //TODO: need to add fake ids to anyone that doesn't have them\n    //FIXME: make this safer - break into multiple passes\n    var idCount = {};\n\n    function generateId(type){\n        if(idCount[type] === undefined) idCount[type] = 0;\n\n        var count = idCount[type]++;\n        return '$generated-' + type + '-' + count; \n    }\n\n    function wrapInFakeRootState(state){\n        return {\n            $deserializeDatamodel : state.$deserializeDatamodel || function(){},\n            $serializeDatamodel : state.$serializeDatamodel || function(){ return null;},\n            $idToStateMap : idToStateMap,   //keep this for handy deserialization of serialized configuration\n            states : [\n                {\n                    $type : 'initial',\n                    transitions : [{\n                        target : state\n                    }]\n                },\n                state\n            ]\n        };\n    }\n\n    var statesWithInitialAttributes = [];\n\n    function transitionToString(sourceState){\n      return `${sourceState} -- ${this.events ? '(' + this.events.join(',') + ')' : null}${this.cond ? '[' + this.cond.name + ']' : ''} --> ${this.targets ? this.targets.join(',') : null}`;\n    }\n\n    function stateToString(){\n      return this.id;\n    }\n\n    function traverse(ancestors,state){\n\n        if(printTrace) state.toString = stateToString;\n\n        //add to global transition and state id caches\n        if(state.transitions) transitions.push.apply(transitions,state.transitions);\n\n        //populate state id map\n        if(state.id){\n            if(idToStateMap.has(state.id)) throw new Error('Redefinition of state id ' + state.id);\n\n            idToStateMap.set(state.id, state);\n        }\n\n        //create a default type, just to normalize things\n        //this way we can check for unsupported types below\n        state.$type = state.$type || 'state';\n\n        //add ancestors and depth properties\n        state.ancestors = ancestors;\n        state.depth = ancestors.length;\n        state.parent = ancestors[0];\n        state.documentOrder = documentOrder++; \n\n        //add some information to transitions\n        state.transitions = state.transitions || [];\n        for (var j = 0, len = state.transitions.length; j < len; j++) {\n            var transition = state.transitions[j];\n            transition.documentOrder = documentOrder++; \n            transition.source = state;\n            if(printTrace) transition.toString = transitionToString.bind(transition, state);\n        };\n\n        //recursive step\n        if(state.states) {\n            var ancs = [state].concat(ancestors);\n            for (var j = 0, len = state.states.length; j < len; j++) {\n                traverse(ancs, state.states[j]);\n            }\n        }\n\n        //setup fast state type\n        switch(state.$type){\n            case 'parallel':\n                state.typeEnum = STATE_TYPES.PARALLEL;\n                break;\n            case 'initial' : \n                state.typeEnum = STATE_TYPES.INITIAL;\n                break;\n            case 'history' :\n                state.typeEnum = STATE_TYPES.HISTORY;\n                break;\n            case 'final' : \n                state.typeEnum = STATE_TYPES.FINAL;\n                break;\n            case 'state' : \n            case 'scxml' :\n                if(state.states && state.states.length){\n                    state.typeEnum = STATE_TYPES.COMPOSITE;\n                }else{\n                    state.typeEnum = STATE_TYPES.BASIC;\n                }\n                break;\n            default :\n                throw new Error('Unknown state type: ' + state.$type);\n        }\n\n        //descendants property on states will now be populated. add descendants to this state\n        if(state.states){\n            state.descendants = state.states.concat(state.states.map(function(s){return s.descendants;}).reduce(function(a,b){return a.concat(b);},[]));\n        }else{\n            state.descendants = [];\n        }\n\n        var initialChildren;\n        if(state.typeEnum === STATE_TYPES.COMPOSITE){\n            //set up initial state\n            \n            if(typeof state.initial === 'string'){\n                statesWithInitialAttributes.push(state);\n            }else{\n                //take the first child that has initial type, or first child\n                initialChildren = state.states.filter(function(child){\n                    return child.$type === 'initial';\n                });\n\n                state.initialRef = initialChildren.length ? initialChildren[0] : state.states[0];\n                checkInitialRef(state);\n            }\n\n        }\n\n        //hook up history\n        if(state.typeEnum === STATE_TYPES.COMPOSITE ||\n                state.typeEnum === STATE_TYPES.PARALLEL){\n\n            var historyChildren = state.states.filter(function(s){\n                return s.$type === 'history';\n            }); \n\n           state.historyRef = historyChildren[0];\n        }\n\n        //now it's safe to fill in fake state ids\n        if(!state.id){\n            state.id = generateId(state.$type);\n            idToStateMap.set(state.id, state);\n        }\n\n        //normalize onEntry/onExit, which can be single fn or array\n        if (state.onEntry && !Array.isArray(state.onEntry)) {\n            state.onEntry = [state.onEntry];\n        }\n\n        if (state.onExit && !Array.isArray(state.onExit)) {\n            state.onExit = [state.onExit];\n        }\n    }\n\n    //TODO: convert events to regular expressions in advance\n\n    function checkInitialRef(state){\n      if(!state.initialRef) throw new Error('Unable to locate initial state for composite state: ' + state.id);\n    }\n    function connectIntialAttributes(){\n      for (var j = 0, len = statesWithInitialAttributes.length; j < len; j++) {\n        var s = statesWithInitialAttributes[j];\n        s.initialRef = idToStateMap.get(s.initial);\n        checkInitialRef(s);\n      }\n    }\n\n    var RX_WHITESPACE = /\\s+/;\n\n    function connectTransitionGraph(){\n        //normalize as with onEntry/onExit\n        for (var i = 0, len = transitions.length; i < len; i++) {\n            var t = transitions[i];\n            if (t.onTransition && !Array.isArray(t.onTransition)) {\n                t.onTransition = [t.onTransition];\n            }\n\n            //normalize \"event\" attribute into \"events\" attribute\n            if (typeof t.event === 'string') {\n                t.events = t.event.trim().split(RX_WHITESPACE);\n            }\n            delete t.event;\n\n            if(t.targets || (typeof t.target === 'undefined')) {\n                //targets have already been set up\n                continue;\n            }   \n\n            if(typeof t.target === 'string'){\n                var target = idToStateMap.get(t.target);\n                if(!target) throw new Error('Unable to find target state with id ' + t.target);\n                t.target = target;\n                t.targets = [t.target];\n            }else if(Array.isArray(t.target)){\n                t.targets = t.target.map(function(target){\n                    if(typeof target === 'string'){\n                        target = idToStateMap.get(target);\n                        if(!target) throw new Error('Unable to find target state with id ' + t.target);\n                        return target;\n                    }else{\n                        return target;\n                    } \n                }); \n            }else if(typeof t.target === 'object'){\n                t.targets = [t.target];\n            }else{\n                throw new Error('Transition target has unknown type: ' + t.target);\n            }\n        }\n\n        //hook up LCA - optimization\n        for (var i = 0, len = transitions.length; i < len; i++) {\n            var t = transitions[i];\n            if(t.targets) t.lcca = getLCCA(t.source,t.targets[0]);    //FIXME: we technically do not need to hang onto the lcca. only the scope is used by the algorithm\n\n            t.scope = getScope(t);\n            //console.log('scope',t.source.id,t.scope.id,t.targets);\n        }\n    }\n\n    function getScope(transition){\n        //Transition scope is normally the least common compound ancestor (lcca).\n        //Internal transitions have a scope equal to the source state.\n\n        var transitionIsReallyInternal = \n                transition.type === 'internal' &&\n                    transition.source.parent &&    //root state won't have parent\n                        transition.targets && //does it target its descendants\n                            transition.targets.every(\n                                function(target){ return transition.source.descendants.indexOf(target) > -1;});\n\n        if(!transition.targets){\n            return transition.source; \n        }else if(transitionIsReallyInternal){\n            return transition.source; \n        }else{\n            return transition.lcca;\n        }\n    }\n\n    function getLCCA(s1, s2) {\n        //console.log('getLCCA',s1, s2);\n        var commonAncestors = [];\n        for (var j = 0, len = s1.ancestors.length; j < len; j++) {\n            var anc = s1.ancestors[j];\n            //console.log('s1.id',s1.id,'anc',anc.id,'anc.typeEnum',anc.typeEnum,'s2.id',s2.id);\n            if(anc.typeEnum === STATE_TYPES.COMPOSITE &&\n                anc.descendants.indexOf(s2) > -1){\n                commonAncestors.push(anc);\n            }\n        };\n        //console.log('commonAncestors',s1.id,s2.id,commonAncestors.map(function(s){return s.id;}));\n        if(!commonAncestors.length) throw new Error(\"Could not find LCA for states.\");\n        return commonAncestors[0];\n    }\n\n    //main execution starts here\n    //FIXME: only wrap in root state if it's not a compound state\n    var fakeRootState = wrapInFakeRootState(rootState);  //I wish we had pointer semantics and could make this a C-style \"out argument\". Instead we return him\n    traverse([],fakeRootState);\n    connectTransitionGraph();\n    connectIntialAttributes();\n\n    return fakeRootState;\n}\n\n/* begin tiny-events: https://github.com/ZauberNerd/tiny-events */\nfunction EventEmitter() {\n    this._listeners = {};\n    this._listeners['*'] = [];\n}\n\nEventEmitter.prototype.on = function _on(type, listener) {\n    if (!Array.isArray(this._listeners[type])) {\n        this._listeners[type] = [];\n    }\n\n    if (this._listeners[type].indexOf(listener) === -1) {\n        this._listeners[type].push(listener);\n    }\n\n    return this;\n};\n\nEventEmitter.prototype.once = function _once(type, listener) {\n    var self = this;\n\n    function __once() {\n        for (var args = [], i = 0; i < arguments.length; i += 1) {\n            args[i] = arguments[i];\n        }\n\n        self.off(type, __once);\n        listener.apply(self, args);\n    }\n\n    __once.listener = listener;\n\n    return this.on(type, __once);\n};\n\nEventEmitter.prototype.off = function _off(type, listener) {\n    if (!Array.isArray(this._listeners[type])) {\n        return this;\n    }\n\n    if (typeof listener === 'undefined') {\n        this._listeners[type] = [];\n        return this;\n    }\n\n    var index = this._listeners[type].indexOf(listener);\n\n    if (index === -1) {\n        for (var i = 0; i < this._listeners[type].length; i += 1) {\n            if (this._listeners[type][i].listener === listener) {\n                index = i;\n                break;\n            }\n        }\n    }\n\n    this._listeners[type].splice(index, 1);\n    return this;\n};\n\nEventEmitter.prototype.emit = function _emit(type) {\n\n    var args = Array.prototype.slice.call(arguments);\n    var modifiedArgs = args.slice(1);\n\n    var listeners = this._listeners[type];\n    var j, len;\n    if (Array.isArray(listeners)) {\n      for (j = 0, len = listeners.length; j < len; j++) {\n        listeners[j].apply(this, modifiedArgs);\n      }\n    }\n\n    //special '*' event\n    listeners = this._listeners['*'];\n    for (j = 0, len = listeners.length; j < len; j++) {\n        listeners[j].apply(this, args);\n    }\n\n    return this;\n};\n\n/* end tiny-events */\n\n/* begin ArraySet */\n\n/** @constructor */\nfunction ArraySet(l) {\n    l = l || [];\n    this.o = new Set(l);        \n}\n\nArraySet.prototype = {\n\n    add : function(x) {\n        this.o.add(x);\n    },\n\n    remove : function(x) {\n        return this.o.delete(x);\n    },\n\n    union : function(l) {\n        for (var v of l.o) {\n            this.o.add(v);\n        }\n        return this;\n    },\n\n    difference : function(l) {\n        for (var v of l.o) {\n            this.o.delete(v);\n        }\n        return this;\n    },\n\n    contains : function(x) {\n        return this.o.has(x);\n    },\n\n    iter : function() {\n        return Array.from(this.o);\n    },\n\n    isEmpty : function() {\n        return !this.o.size;\n    },\n\n    size: function() {\n        return this.o.size;\n    },\n\n    equals : function(s2) {\n        if (this.o.size !== s2.size()) {\n            return false;\n        }\n\n        for (var v of this.o) {\n            if (!s2.contains(v)) {\n                return false;\n            }\n        }\n\n        return true;\n    },\n\n    toString : function() {\n        return this.o.size === 0 ? '<empty>' : Array.from(this.o).join(',\\n');\n    }\n};\n\nconst RX_TRAILING_WILDCARD = /\\.\\*$/;\n\nfunction isEventPrefixMatch(prefix, fullName) {\n    prefix = prefix.replace(RX_TRAILING_WILDCARD, '');\n\n    if (prefix === fullName) {\n        return true;\n    }\n\n    if (prefix.length > fullName.length) {\n        return false;\n    }\n\n    if (fullName.charAt(prefix.length) !== '.') {\n        return false;\n    }\n\n    return (fullName.indexOf(prefix) === 0);\n}\n\nfunction isTransitionMatch(t, eventName) {\n    return t.events.some((tEvent) => {\n        return tEvent === '*' || isEventPrefixMatch(tEvent, eventName);\n    });\n}\n\nfunction scxmlPrefixTransitionSelector(state, event, evaluator, selectEventlessTransitions) {\n    return state.transitions.filter((t) => {\n        return ( \n          selectEventlessTransitions ? \n            !t.events :\n            (!t.events || (event && event.name && isTransitionMatch(t, event.name)))\n          )\n          && (!t.cond || evaluator(t.cond));\n    });\n}\n\nfunction eventlessTransitionSelector(state){\n  return state.transitions.filter(function(transition){ return !transition.events || ( transition.events && transition.events.length === 0 ); });\n}\n\n//model accessor functions\nvar query = {\n    getAncestors: function(s, root) {\n        var ancestors, index, state;\n        index = s.ancestors.indexOf(root);\n        if (index > -1) {\n            return s.ancestors.slice(0, index);\n        } else {\n            return s.ancestors;\n        }\n    },\n    /** @this {model} */\n    getAncestorsOrSelf: function(s, root) {\n        return [s].concat(this.getAncestors(s, root));\n    },\n    getDescendantsOrSelf: function(s) {\n        return [s].concat(s.descendants);\n    },\n    /** @this {model} */\n    isOrthogonalTo: function(s1, s2) {\n        //Two control states are orthogonal if they are not ancestrally\n        //related, and their smallest, mutual parent is a Concurrent-state.\n        return !this.isAncestrallyRelatedTo(s1, s2) && this.getLCA(s1, s2).typeEnum === STATE_TYPES.PARALLEL;\n    },\n    /** @this {model} */\n    isAncestrallyRelatedTo: function(s1, s2) {\n        //Two control states are ancestrally related if one is child/grandchild of another.\n        return this.getAncestorsOrSelf(s2).indexOf(s1) > -1 || this.getAncestorsOrSelf(s1).indexOf(s2) > -1;\n    },\n    /** @this {model} */\n    getLCA: function(s1, s2) {\n        var commonAncestors = this.getAncestors(s1).filter(function(a){\n            return a.descendants.indexOf(s2) > -1;\n        },this);\n        return commonAncestors[0];\n    }\n};\n\n//priority comparison functions\nfunction getTransitionWithHigherSourceChildPriority([t1, t2]) {\n    \n    var r = getStateWithHigherSourceChildPriority(t1.source, t2.source);\n    switch(r){\n      case 0:\n        //should only occur when t1 and t2 have same source state\n        if (t1.documentOrder < t2.documentOrder) {\n            return t1;\n        } else {\n            return t2;\n        }\n      case -1:\n        return t1;\n      case 1:\n        return t2;\n      default:\n        throw new Error('Unexpected return value');\n    }\n}\n\nfunction getStateWithHigherSourceChildPriority(s1, s2) {\n    //compare states based first on depth, then based on document order\n    console.log('getStateWithHigherSourceChildPriority', s1.id, s1.depth, s1.documentOrder, s2.id, s2.depth, s2.documentOrder);\n    if (s1.depth > s2.depth) {\n        return -1;\n    } else if (s1.depth < s2.depth) {\n        return 1;\n    } else {\n        //Equality\n        if (s1.documentOrder < s2.documentOrder) {\n            return 1;\n        } else if (s1.documentOrder > s2.documentOrder) {\n            return -1;\n        } else{\n            return 0;\n        }\n    }\n}\n\nfunction initializeModelGeneratorFn(modelFn, opts, interpreter){\n\n     opts.x =  opts.x || {};\n\n    return modelFn.call(interpreter,\n        opts.x,\n        opts.sessionid,\n        opts.ioprocessors,\n        interpreter.isIn.bind(interpreter));\n}\n\nfunction deserializeSerializedConfiguration(serializedConfiguration,idToStateMap){\n  return serializedConfiguration.map(function(id){\n    var state = idToStateMap.get(id);\n    if(!state) throw new Error('Error loading serialized configuration. Unable to locate state with id ' + id);\n    return state;\n  });\n}\n\nfunction deserializeHistory(serializedHistory,idToStateMap){\n  var o = {};\n  Object.keys(serializedHistory).forEach(function(sid){\n    o[sid] = serializedHistory[sid].map(function(id){\n      var state = idToStateMap.get(id);\n      if(!state) throw new Error('Error loading serialized history. Unable to locate state with id ' + id);\n      return state;\n    });\n  });\n  return o;\n}\n\n/** @const */\nvar printTrace = false;\n\nBaseInterpreter.EVENTS = [\n  'onEntry',\n  'onExit',\n  'onTransition',\n  'onError',\n  'onBigStepBegin',\n  'onBigStepSuspend',\n  'onBigStepResume',\n  'onSmallStepBegin',\n  'onSmallStepEnd',\n  'onBigStepEnd'\n];\n\n/** @constructor */\nfunction BaseInterpreter(modelOrFnGenerator, opts){\n\n    EventEmitter.call(this);\n\n    this._scriptingContext = opts.interpreterScriptingContext || (opts.InterpreterScriptingContext ? new opts.InterpreterScriptingContext(this) : {}); \n\n    var model;\n    if(typeof modelOrFnGenerator === 'function'){\n        model = initializeModelGeneratorFn(modelOrFnGenerator, opts, this);\n    }else if(typeof modelOrFnGenerator === 'string'){\n        model = JSON.parse(modelOrFnGenerator);\n    }else{\n        model = modelOrFnGenerator;\n    }\n\n    this._model = initializeModel(model);\n\n    //console.log(require('util').inspect(this._model,false,4));\n   \n    this.opts = opts || {};\n\n    this.opts.console = opts.console || (typeof console === 'undefined' ? {log : function(){}} : console);   //rely on global console if this console is undefined\n    this.opts.Set = this.opts.Set || ArraySet;\n    this.opts.priorityComparisonFn = this.opts.priorityComparisonFn || getTransitionWithHigherSourceChildPriority;\n    this.opts.transitionSelector = this.opts.transitionSelector || scxmlPrefixTransitionSelector;\n\n    this._scriptingContext.log = this._scriptingContext.log || (function log(){ \n      if(this.opts.console.log.apply){\n        this.opts.console.log.apply(this.opts.console, arguments); \n      } else {\n        //console.log on older IE does not support Function.apply, so just pass him the first argument. Best we can do for now.\n        this.opts.console.log(Array.prototype.slice.apply(arguments).join(',')); \n      }\n    }.bind(this));   //set up default scripting context log function\n\n    this._internalEventQueue = [];\n\n    //check if we're loading from a previous snapshot\n    if(opts.snapshot){\n      this._configuration = new this.opts.Set(deserializeSerializedConfiguration(opts.snapshot[0], this._model.$idToStateMap));\n      this._historyValue = deserializeHistory(opts.snapshot[1], this._model.$idToStateMap); \n      this._isInFinalState = opts.snapshot[2];\n      this._model.$deserializeDatamodel(opts.snapshot[3]);   //load up the datamodel\n    }else{\n      this._configuration = new this.opts.Set();\n      this._historyValue = {};\n      this._isInFinalState = false;\n    }\n\n    //SCXML system variables:\n    this._x = {\n        _sessionId : opts.sessionId || null,\n        _name : model.name || opts.name || null,\n        _ioprocessors : opts.ioprocessors || null\n    };\n\n    //add debug logging\n    BaseInterpreter.EVENTS.forEach(function(event){\n      this.on(event, this._log.bind(this,event));\n    }, this);\n}\n\nBaseInterpreter.prototype = extend(beget(EventEmitter.prototype),{\n\n    /** @expose */\n    start : function() {\n        //perform big step without events to take all default transitions and reach stable initial state\n        this._log(\"performing initial big step\");\n\n        //We effectively need to figure out states to enter here to populate initial config. assuming root is compound state makes this simple.\n        //but if we want it to be parallel, then this becomes more complex. so when initializing the model, we add a 'fake' root state, which\n        //makes the following operation safe.\n        this._configuration.add(this._model.initialRef);   \n\n        this._performBigStep();\n        return this.getConfiguration();\n    },\n\n    /**\n     * Starts the interpreter asynchronously\n     * @param  {Function} cb Callback invoked with an error or the interpreter's stable configuration\n     * @expose\n     */\n    startAsync : function(cb) {\n        if (typeof cb !== 'function') {\n            cb = nop;\n        }\n\n        this._log(\"performing initial big step\");\n\n        this._configuration.add(this._model.initialRef);\n\n        this._performBigStepAsync(null, cb);\n    },\n\n    /** @expose */\n    getConfiguration : function() {\n        return this._configuration.iter().map(function(s){return s.id;});\n    },\n\n    /** @expose */\n    getFullConfiguration : function() {\n        return this._configuration.iter().\n                map(function(s){ return [s].concat(query.getAncestors(s));},this).\n                reduce(function(a,b){return a.concat(b);},[]).    //flatten\n                map(function(s){return s.id;}).\n                reduce(function(a,b){return a.indexOf(b) > -1 ? a : a.concat(b);},[]); //uniq\n    },\n\n\n    /** @expose */\n    isIn : function(stateName) {\n        return this.getFullConfiguration().indexOf(stateName) > -1;\n    },\n\n    /** @expose */\n    isFinal : function(stateName) {\n        return this._isInFinalState;\n    },\n\n    /** @private */\n    _performBigStep : function(e) {\n        this.emit('onBigStepBegin');\n        if (e) this._internalEventQueue.push(e);\n        var keepGoing = true;\n        while (keepGoing) {\n            var currentEvent = this._internalEventQueue.shift() || null;\n            var selectedTransitions  = this._selectTransitions(currentEvent, true);\n            if(selectedTransitions.isEmpty()){\n              selectedTransitions = this._selectTransitions(currentEvent, false);\n            }\n\n            this.emit('onSmallStepBegin', currentEvent);\n            this._performSmallStep(currentEvent, selectedTransitions);\n            this.emit('onSmallStepEnd', currentEvent);\n            keepGoing = !selectedTransitions.isEmpty();\n        }\n        this._isInFinalState = this._configuration.iter().every(function(s){ return s.typeEnum === STATE_TYPES.FINAL; });\n        this.emit('onBigStepEnd');\n    },\n\n    _performBigStepAsync : function(event, cb) {\n        if (event) {\n            this._internalEventQueue.push(event);\n        }\n\n        var self = this;\n        function doBigStep(eventToEmit) {\n            var selectedTransitions;\n            try {\n                self.emit(eventToEmit);\n                var currentEvent = self._internalEventQueue.shift() || null;\n                var selectedTransitions  = self._selectTransitions(currentEvent, true);\n                if(selectedTransitions.isEmpty()){\n                  selectedTransitions = self._selectTransitions(currentEvent, false);\n                }\n\n                self.emit('onSmallStepBegin', currentEvent);\n                self._performSmallStep(currentEvent, selectedTransitions);\n                self.emit('onSmallStepEnd', currentEvent);\n            } catch(err) {\n                cb(err);\n                return;\n            }\n\n            if (!selectedTransitions.isEmpty()) {\n                // keep going, but be nice (yield) to the process\n                // TODO: for compat with non-node, non-mozilla\n                // allow the context to provide the defer task function\n                self.emit('onBigStepSuspend');\n                setImmediate(doBigStep, 'onBigStepResume');\n            } else {\n                self._isInFinalState =\n                    self._configuration.iter().every(function(s) {\n                        return s.typeEnum === STATE_TYPES.FINAL;\n                    });\n                self.emit('onBigStepEnd');\n                cb(undefined, self.getConfiguration());\n            }\n        }\n\n        doBigStep('onBigStepBegin');\n    },\n\n    /** @private */\n    _performSmallStep : function(currentEvent, selectedTransitions) {\n\n        this._log(\"selecting transitions with currentEvent\", JSON.stringify(currentEvent));\n\n        this._log(\"selected transitions\", selectedTransitions);\n\n        if (!selectedTransitions.isEmpty()) {\n\n            this._log(\"sorted transitions\", selectedTransitions);\n\n            //we only want to enter and exit states from transitions with targets\n            //filter out targetless transitions here - we will only use these to execute transition actions\n            var selectedTransitionsWithTargets = new this.opts.Set(selectedTransitions.iter().filter(transitionWithTargets));\n\n            var exitedTuple = this._getStatesExited(selectedTransitionsWithTargets), \n                basicStatesExited = exitedTuple[0], \n                statesExited = exitedTuple[1];\n\n            var enteredTuple = this._getStatesEntered(selectedTransitionsWithTargets), \n                basicStatesEntered = enteredTuple[0], \n                statesEntered = enteredTuple[1];\n\n            this._log(\"basicStatesExited \", basicStatesExited);\n            this._log(\"basicStatesEntered \", basicStatesEntered);\n            this._log(\"statesExited \", statesExited);\n            this._log(\"statesEntered \", statesEntered);\n\n            var eventsToAddToInnerQueue = new this.opts.Set();\n\n            //update history states\n            this._log(\"executing state exit actions\");\n\n            for (var j = 0, len = statesExited.length; j < len; j++) {\n                var stateExited = statesExited[j];\n\n                this._log(\"exiting \", stateExited.id);\n\n                //invoke listeners\n                this.emit('onExit',stateExited.id)\n\n                if(stateExited.onExit !== undefined) {\n                    for (var exitIdx = 0, exitLen = stateExited.onExit.length; exitIdx < exitLen; exitIdx++) {\n                        this._evaluateAction(currentEvent, stateExited.onExit[exitIdx]);\n                    }\n                }\n\n                var f;\n                if (stateExited.historyRef) {\n                    if (stateExited.historyRef.isDeep) {\n                        f = function(s0) {\n                            return s0.typeEnum === STATE_TYPES.BASIC && stateExited.descendants.indexOf(s0) > -1;\n                        };\n                    } else {\n                        f = function(s0) {\n                            return s0.parent === stateExited;\n                        };\n                    }\n                    //update history\n                    this._historyValue[stateExited.historyRef.id] = statesExited.filter(f);\n                }\n            }\n\n            // -> Concurrency: Number of transitions: Multiple\n            // -> Concurrency: Order of transitions: Explicitly defined\n            var sortedTransitions = selectedTransitions.iter().sort(transitionComparator);\n\n            this._log(\"executing transitition actions\");\n\n\n            for (var stxIdx = 0, len = sortedTransitions.length; stxIdx < len; stxIdx++) {\n                var transition = sortedTransitions[stxIdx];\n\n                var targetIds = transition.targets && transition.targets.map(function(target){return target.id;});\n\n                this.emit('onTransition',transition.source.id,targetIds, stxIdx);\n\n                if(transition.onTransition !== undefined) {\n                    for (var txIdx = 0, txLen = transition.onTransition.length; txIdx < txLen; txIdx++) {\n                        this._evaluateAction(currentEvent, transition.onTransition[txIdx]);\n                    }\n                }\n            }\n \n            this._log(\"executing state enter actions\");\n\n            for (var enterIdx = 0, enterLen = statesEntered.length; enterIdx < enterLen; enterIdx++) {\n                var stateEntered = statesEntered[enterIdx];\n\n                this._log(\"entering\", stateEntered.id);\n\n                this.emit('onEntry',stateEntered.id);\n\n                if(stateEntered.onEntry !== undefined) {\n                    for (var entryIdx = 0, entryLen = stateEntered.onEntry.length; entryIdx < entryLen; entryIdx++) {\n                        this._evaluateAction(currentEvent, stateEntered.onEntry[entryIdx]);\n                    }\n                }\n            }\n\n            this._log(\"updating configuration \");\n            this._log(\"old configuration \", this._configuration);\n\n            //update configuration by removing basic states exited, and adding basic states entered\n            this._configuration.difference(basicStatesExited);\n            this._configuration.union(basicStatesEntered);\n\n\n            this._log(\"new configuration \", this._configuration);\n            \n            //add set of generated events to the innerEventQueue -> Event Lifelines: Next small-step\n            if (!eventsToAddToInnerQueue.isEmpty()) {\n                this._log(\"adding triggered events to inner queue \", eventsToAddToInnerQueue);\n                this._internalEventQueue.push(eventsToAddToInnerQueue);\n            }\n\n        }\n\n        //if selectedTransitions is empty, we have reached a stable state, and the big-step will stop, otherwise will continue -> Maximality: Take-Many\n        return selectedTransitions;\n    },\n\n    /** @private */\n    _evaluateAction : function(currentEvent, actionRef) {\n        try {\n          return actionRef.call(this._scriptingContext, currentEvent);     //SCXML system variables\n        } catch (e){\n          var err = {\n            tagname: actionRef.tagname, \n            line: actionRef.line, \n            column: actionRef.column,\n            reason: e.message\n          }\n          this._internalEventQueue.push({\"name\":\"error.execution\",data : err});\n          this.emit('onError', err);\n        }\n    },\n\n    /** @private */\n    _getStatesExited : function(transitions) {\n        var statesExited = new this.opts.Set();\n        var basicStatesExited = new this.opts.Set();\n\n        //States exited are defined to be active states that are\n        //descendants of the scope of each priority-enabled transition.\n        //Here, we iterate through the transitions, and collect states\n        //that match this condition. \n        var transitionList = transitions.iter();\n        for (var txIdx = 0, txLen = transitionList.length; txIdx < txLen; txIdx++) {\n            var transition = transitionList[txIdx];\n            var scope = transition.scope,\n                desc = scope.descendants;\n\n            //For each state in the configuration\n            //is that state a descendant of the transition scope?\n            //Store ancestors of that state up to but not including the scope.\n            var configList = this._configuration.iter();\n            for (var cfgIdx = 0, cfgLen = configList.length; cfgIdx < cfgLen; cfgIdx++) {\n                var state = configList[cfgIdx];\n                if(desc.indexOf(state) > -1){\n                    basicStatesExited.add(state);\n                    statesExited.add(state);\n                    var ancestors = query.getAncestors(state,scope); \n                    for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) { \n                        statesExited.add(ancestors[ancIdx]);\n                    }\n                }\n            }\n        }\n\n        var sortedStatesExited = statesExited.iter().sort(getStateWithHigherSourceChildPriority);\n        return [basicStatesExited, sortedStatesExited];\n    },\n\n    /** @private */\n    _getStatesEntered : function(transitions) {\n\n        var o = {\n            statesToEnter : new this.opts.Set(),\n            basicStatesToEnter : new this.opts.Set(),\n            statesProcessed  : new this.opts.Set(),\n            statesToProcess : []\n        };\n\n        //do the initial setup\n        var transitionList = transitions.iter();\n        for (var txIdx = 0, txLen = transitionList.length; txIdx < txLen; txIdx++) {\n            var transition = transitionList[txIdx];\n            for (var targetIdx = 0, targetLen = transition.targets.length; targetIdx < targetLen; targetIdx++) {\n                this._addStateAndAncestors(transition.targets[targetIdx],transition.scope,o);\n            }\n        }\n\n        //loop and add states until there are no more to add (we reach a stable state)\n        var s;\n        /*jsl:ignore*/\n        while(s = o.statesToProcess.pop()){\n            /*jsl:end*/\n            this._addStateAndDescendants(s,o);\n        }\n\n        //sort based on depth\n        var sortedStatesEntered = o.statesToEnter.iter().sort(\n          function(s1, s2){\n            return getStateWithHigherSourceChildPriority(s1, s2) * -1\n          });\n\n        return [o.basicStatesToEnter, sortedStatesEntered];\n    },\n\n    /** @private */\n    _addStateAndAncestors : function(target,scope,o){\n\n        //process each target\n        this._addStateAndDescendants(target,o);\n\n        //and process ancestors of targets up to the scope, but according to special rules\n        var ancestors = query.getAncestors(target,scope);\n        for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) {\n            var s = ancestors[ancIdx];\n            if (s.typeEnum === STATE_TYPES.COMPOSITE) {\n                //just add him to statesToEnter, and declare him processed\n                //this is to prevent adding his initial state later on\n                o.statesToEnter.add(s);\n\n                o.statesProcessed.add(s);\n            }else{\n                //everything else can just be passed through as normal\n                this._addStateAndDescendants(s,o);\n            } \n        }\n    },\n\n    /** @private */\n    _addStateAndDescendants : function(s,o){\n\n        if(o.statesProcessed.contains(s)) return;\n\n        if (s.typeEnum === STATE_TYPES.HISTORY) {\n            if (s.id in this._historyValue) {\n                this._historyValue[s.id].forEach(function(stateFromHistory){\n                    this._addStateAndAncestors(stateFromHistory,s.parent,o);\n                },this);\n            } else {\n                o.statesToEnter.add(s);\n                o.basicStatesToEnter.add(s);\n            }\n        } else {\n            o.statesToEnter.add(s);\n\n            if (s.typeEnum === STATE_TYPES.PARALLEL) {\n                o.statesToProcess.push.apply(o.statesToProcess,\n                    s.states.filter(function(s){return s.typeEnum !== STATE_TYPES.HISTORY;}));\n            } else if (s.typeEnum === STATE_TYPES.COMPOSITE) {\n                o.statesToProcess.push(s.initialRef); \n            } else if (s.typeEnum === STATE_TYPES.INITIAL || s.typeEnum === STATE_TYPES.BASIC || s.typeEnum === STATE_TYPES.FINAL) {\n                o.basicStatesToEnter.add(s);\n            }\n        }\n\n        o.statesProcessed.add(s); \n    },\n\n    /** @private */\n    _selectTransitions : function(currentEvent, selectEventlessTransitions) {\n        if (this.opts.onlySelectFromBasicStates) {\n            var states = this._configuration.iter();\n        } else {\n            var statesAndParents = new this.opts.Set;\n\n            //get full configuration, unordered\n            //this means we may select transitions from parents before states\n            var configList = this._configuration.iter();\n            for (var idx = 0, len = configList.length; idx < len; idx++) {\n                var basicState = configList[idx];\n                statesAndParents.add(basicState);\n                var ancestors = query.getAncestors(basicState);\n                for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) {\n                    statesAndParents.add(ancestors[ancIdx]);\n                }\n            }\n\n            states = statesAndParents.iter();\n        }\n\n        var transitionSelector = this.opts.transitionSelector;\n        var enabledTransitions = new this.opts.Set();\n\n        var e = this._evaluateAction.bind(this,currentEvent);\n\n        for (var stateIdx = 0, stateLen = states.length; stateIdx < stateLen; stateIdx++) {\n            var transitions = transitionSelector(states[stateIdx], currentEvent, e, selectEventlessTransitions);\n            for (var txIdx = 0, len = transitions.length; txIdx < len; txIdx++) {\n                enabledTransitions.add(transitions[txIdx]);\n            }\n        }\n\n        var priorityEnabledTransitions = this._selectPriorityEnabledTransitions(enabledTransitions);\n\n        this._log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n        \n        return priorityEnabledTransitions;\n    },\n\n    /** @private */\n    _selectPriorityEnabledTransitions : function(enabledTransitions) {\n        var priorityEnabledTransitions = new this.opts.Set();\n\n        var tuple = this._getInconsistentTransitions(enabledTransitions), \n            consistentTransitions = tuple[0], \n            inconsistentTransitionsPairs = tuple[1];\n\n        priorityEnabledTransitions.union(consistentTransitions);\n\n        this._log(\"enabledTransitions\", enabledTransitions);\n        this._log(\"consistentTransitions\", consistentTransitions);\n        this._log(\"inconsistentTransitionsPairs\", inconsistentTransitionsPairs);\n        this._log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n        \n        while (!inconsistentTransitionsPairs.isEmpty()) {\n            enabledTransitions = new this.opts.Set(\n                    inconsistentTransitionsPairs.iter().map(function(t){return this.opts.priorityComparisonFn(t);},this));\n\n            tuple = this._getInconsistentTransitions(enabledTransitions);\n            consistentTransitions = tuple[0]; \n            inconsistentTransitionsPairs = tuple[1];\n\n            priorityEnabledTransitions.union(consistentTransitions);\n\n            this._log(\"enabledTransitions\", enabledTransitions);\n            this._log(\"consistentTransitions\", consistentTransitions);\n            this._log(\"inconsistentTransitionsPairs\", inconsistentTransitionsPairs);\n            this._log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n            \n        }\n        return priorityEnabledTransitions;\n    },\n\n    /** @private */\n    _getInconsistentTransitions : function(transitions) {\n        var allInconsistentTransitions = new this.opts.Set();\n        var inconsistentTransitionsPairs = new this.opts.Set();\n        var transitionList = transitions.iter();\n\n        this._log(\"transitions\", transitions);\n\n        for(var i = 0; i < transitionList.length; i++){\n            for(var j = i+1; j < transitionList.length; j++){\n                var t1 = transitionList[i];\n                var t2 = transitionList[j];\n                if (this._conflicts(t1, t2)) {\n                    allInconsistentTransitions.add(t1);\n                    allInconsistentTransitions.add(t2);\n                    inconsistentTransitionsPairs.add([t1, t2]);\n                }\n            }\n        }\n\n        var consistentTransitions = transitions.difference(allInconsistentTransitions);\n        return [consistentTransitions, inconsistentTransitionsPairs];\n    },\n\n    _log : function(){\n      if(printTrace){\n        var args = Array.from(arguments);\n        this.opts.console.log( \n          `${args[0]}: ${\n            args.slice(1).map(function(arg){\n              return arg === null ? 'null' : \n                ( arg === undefined ? 'undefined' : \n                  ( typeof arg === 'string' ? arg : \n                    ( arg.__proto__ === Object.prototype ? JSON.stringify(arg) : arg.toString())));\n\n            }).join(', ')\n          }\\n`\n        );\n      }\n    },\n\n    /** @private */\n    _conflicts : function(t1, t2) {\n        return !this._isArenaOrthogonal(t1, t2);\n    },\n\n    /** @private */\n    _isArenaOrthogonal : function(t1, t2) {\n\n        this._log(\"transition scopes\", t1.scope, t2.scope);\n\n        var isOrthogonal = query.isOrthogonalTo(t1.scope, t2.scope);\n\n        this._log(\"transition scopes are orthogonal?\", isOrthogonal);\n\n        return isOrthogonal;\n    },\n\n\n    /*\n        registerListener provides a generic mechanism to subscribe to state change and runtime error notifications.\n        Can be used for logging and debugging. For example, can attach a logger that simply logs the state changes.\n        Or can attach a network debugging client that sends state change notifications to a debugging server.\n    \n        listener is of the form:\n        {\n          onEntry : function(stateId){},\n          onExit : function(stateId){},\n          onTransition : function(sourceStateId,targetStatesIds[]){},\n          onError: function(errorInfo){},\n          onBigStepBegin: function(){},\n          onBigStepResume: function(){},\n          onBigStepSuspend: function(){},\n          onBigStepEnd: function(){}\n          onSmallStepBegin: function(event){},\n          onSmallStepEnd: function(){}\n        }\n    */\n    //TODO: refactor this to be event emitter? \n\n    /** @expose */\n    registerListener : function(listener){\n        BaseInterpreter.EVENTS.forEach(function(event){\n          if(listener[event]) this.on(event,listener[event]);\n        });\n    },\n\n    /** @expose */\n    unregisterListener : function(listener){\n        BaseInterpreter.EVENTS.forEach(function(event){\n          if(listener[event]) this.off(event,listener[event]);\n        });\n    },\n\n    /** @expose */\n    getAllTransitionEvents : function(){\n        var events = {};\n        function getEvents(state){\n\n            if(state.transitions){\n                for (var txIdx = 0, txLen = state.transitions.length; txIdx < txLen; txIdx++) {\n                    events[state.transitions[txIdx].event] = true;\n                }\n            }\n\n            if(state.states) {\n                for (var stateIdx = 0, stateLen = state.states.length; stateIdx < stateLen; stateIdx++) {\n                    getEvents(state.states[stateIdx]);\n                }\n            }\n        }\n\n        getEvents(this._model);\n\n        return Object.keys(events);\n    },\n\n    \n    /** @expose */\n    /**\n      Three things capture the current snapshot of a running SCION interpreter:\n\n      * basic configuration (the set of basic states the state machine is in)\n      * history state values (the states the state machine was in last time it was in the parent of a history state)\n      * the datamodel\n      \n      Note that this assumes that the method to serialize a scion.SCXML\n      instance is not called when the interpreter is executing a big-step (e.g. after\n      scion.SCXML.prototype.gen is called, and before the call to gen returns). If\n      the serialization method is called during the execution of a big-step, then the\n      inner event queue must also be saved. I do not expect this to be a common\n      requirement however, and therefore I believe it would be better to only support\n      serialization when the interpreter is not executing a big-step.\n    */\n    getSnapshot : function(){\n      if(this._isStepping) throw new Error('getSnapshot cannot be called while interpreter is executing a big-step');\n\n\n      return [\n        this.getConfiguration(),\n        this._serializeHistory(),\n        this._isInFinalState,\n        this._model.$serializeDatamodel()\n      ];\n    },\n\n    _serializeHistory : function(){\n      var o = {};\n      Object.keys(this._historyValue).forEach(function(sid){\n        o[sid] = this._historyValue[sid].map(function(state){return state.id});\n      },this);\n      return o;\n    }\n});\n\n/**\n * @constructor\n * @extends BaseInterpreter\n */\nfunction Statechart(model, opts) {\n    opts = opts || {};\n\n    opts.ioprocessors = {};\n\n    //Create all supported Event I/O processor nodes.\n    //TODO fix location after implementing actual processors\n    for (var processorType in ioProcessorTypes) {\n        opts.ioprocessors[processorType] = ioProcessorTypes[processorType];\n    }\n\n    opts.InterpreterScriptingContext = opts.InterpreterScriptingContext || InterpreterScriptingContext;\n\n    this._isStepping = false;\n\n    BaseInterpreter.call(this,model,opts);     //call super constructor\n}\n\nfunction beget(o){\n    function F(){}\n    F.prototype = o;\n    return new F();\n}\n\n/**\n * Do nothing\n */\nfunction nop() {}\n\n//Statechart.prototype = Object.create(BaseInterpreter.prototype);\n//would like to use Object.create here, but not portable, but it's too complicated to use portably\nStatechart.prototype = beget(BaseInterpreter.prototype);    \n\n/** @expose */\nStatechart.prototype.gen = function(evtObjOrName,optionalData) {\n\n    var currentEvent;\n    switch(typeof evtObjOrName){\n        case 'string':\n            currentEvent = {name : evtObjOrName, data : optionalData};\n            break;\n        case 'object':\n            if(typeof evtObjOrName.name === 'string'){\n                currentEvent = evtObjOrName;\n            }else{\n                throw new Error('Event object must have \"name\" property of type string.');\n            }\n            break;\n        default:\n            throw new Error('First argument to gen must be a string or object.');\n    }\n\n    if(this._isStepping) throw new Error('Cannot call gen during a big-step');\n\n    //otherwise, kick him off\n    this._isStepping = true;\n\n    this._performBigStep(currentEvent);\n\n    this._isStepping = false;\n    return this.getConfiguration();\n};\n\n/**\n * Injects an external event into the interpreter asynchronously\n * @param  {object}   currentEvent The event to inject\n * @param {string} currentEvent.name The name of the event\n * @param {string} [currentEvent.data] The event data\n * @param  {Function} cb Callback invoked with an error or the interpreter's stable configuration\n * @expose\n */\nStatechart.prototype.genAsync = function(currentEvent, cb) {\n    if (typeof currentEvent !== 'object' || !currentEvent || typeof currentEvent.name !== 'string') {\n        throw new Error('expected currentEvent to be an Object with a name');\n    }\n\n    if(this._isStepping) {\n        throw new Error('Cannot call gen during a big-step');\n    }\n\n    if (typeof cb !== 'function') {\n        cb = nop;\n    }\n\n    this._isStepping = true;\n\n    var self = this;\n    this._performBigStepAsync(currentEvent, function(err, config) {\n        self._isStepping = false;\n        cb(err, config);\n    });\n};\n\nfunction InterpreterScriptingContext(interpreter) {\n    this._interpreter = interpreter;\n    this._timeoutMap = {};\n}\n\n//Regex from:\n//  http://daringfireball.net/2010/07/improved_regex_for_matching_urls\n//  http://stackoverflow.com/a/6927878\nvar validateUriRegex = /\\b((?:[a-z][\\w-]+:(?:\\/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}\\/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))/i;\n\n//TODO: consider whether this is the API we would like to expose\nInterpreterScriptingContext.prototype = {\n    raise : function(event){\n        this._interpreter._internalEventQueue.push(event); \n    },\n    send : function(event, options){\n        //TODO: move these out\n        function validateSend(event, options, sendAction){\n          if(event.target){\n            var targetIsValidUri = validateUriRegex.test(event.target)\n            if(!targetIsValidUri){\n              return this.raise({ name : \"error.execution\", data: 'Target is not valid URI', sendid: options.sendid });\n            }\n          }\n\n          var eventProcessorTypes = Object.keys(ioProcessorTypes).map(function(k){return ioProcessorTypes[k].location});\n          if(eventProcessorTypes.indexOf(event.type) === -1) {\n              return this.raise({ name : \"error.execution\", data: 'Unsupported event processor type', sendid: options.sendid });\n          }\n\n          sendAction.call(this, event, options);\n        }\n\n        function defaultSendAction (event, options) {\n\n          if( typeof setTimeout === 'undefined' ) throw new Error('Default implementation of Statechart.prototype.send will not work unless setTimeout is defined globally.');\n\n          var timeoutId = setTimeout(this._interpreter.gen.bind(this._interpreter, event), options.delay || 0);\n\n          if (options.sendid) this._timeoutMap[options.sendid] = timeoutId;\n        }\n\n        function publish(){\n          this._interpreter.emit(event.name,event.data);\n        }\n\n        event.type = event.type || ioProcessorTypes.scxml.location;\n\n        //choose send function\n        var sendFn;\n        if(event.type === 'https://github.com/jbeard4/SCION#publish'){\n          sendFn = publish;\n        }else if(this._interpreter.opts.customSend){\n          sendFn = this._interpreter.opts.customSend;\n        }else{\n          sendFn = defaultSendAction;\n        }\n\n        options=options || {};\n\n        this._interpreter._log(\"sending event\", event.name, \"with content\", event.data, \"after delay\", options.delay);\n\n        validateSend.call(this, event, options, sendFn);\n    },\n    cancel : function(sendid){\n        if(this._interpreter.opts.customCancel) {\n            return this._interpreter.opts.customCancel.apply(this, [sendid]);\n        }\n\n        if( typeof clearTimeout === 'undefined' ) throw new Error('Default implementation of Statechart.prototype.cancel will not work unless setTimeout is defined globally.');\n\n        if (sendid in this._timeoutMap) {\n            this._interpreter._log(\"cancelling \", sendid, \" with timeout id \", this._timeoutMap[sendid]);\n            clearTimeout(this._timeoutMap[sendid]);\n        }\n    }\n};\n\nmodule.exports = {\n    /** @expose */\n    BaseInterpreter: BaseInterpreter,\n    /** @expose */\n    Statechart: Statechart,\n    /** @expose */\n    ArraySet : ArraySet,\n    /** @expose */\n    STATE_TYPES : STATE_TYPES,\n    /** @expose */\n    initializeModel : initializeModel,\n    /** @expose */\n    InterpreterScriptingContext : InterpreterScriptingContext,\n    /** @expose */\n    ioProcessorTypes  : ioProcessorTypes \n};\n"]}